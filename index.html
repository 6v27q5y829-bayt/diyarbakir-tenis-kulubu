<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diyarbakƒ±r Tenis Kul√ºb√º</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#065f46">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/33/33736.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/33/33736.png">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Russo+One&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .font-sport { font-family: 'Russo One', sans-serif; letter-spacing: 1px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .logo-container { width: 40px; height: 40px; overflow: hidden; border-radius: 50%; border: 2px solid #bef264; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .student-photo-sm { width: 36px; height: 36px; overflow: hidden; border-radius: 50%; border: 2px solid #fff; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logo-img { width: 100%; height: 100%; object-fit: cover; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .bg-tennis-court {
            background-image: linear-gradient(to bottom, rgba(240, 253, 244, 0.9), rgba(240, 253, 244, 0.95)), url('https://images.unsplash.com/photo-1575361204480-aadea2534679?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        .glass-modal { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .welcome-bg { background-image: linear-gradient(to bottom, rgba(6, 95, 70, 0.8), rgba(6, 78, 59, 0.9)), url('https://images.unsplash.com/photo-1622163642998-1ea36b1ad565?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; }
        .floating-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-radius: 24px 24px 0 0; margin: 0 10px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-tennis-court min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. FIREBASE BA≈ûLATMA (GARANTƒ∞ Y√ñNTEM) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaOllootHtCrBEKEILkvq9cXTTNvZJ38Q",
            authDomain: "diyarbakir-tenis.firebaseapp.com",
            projectId: "diyarbakir-tenis",
            storageBucket: "diyarbakir-tenis.firebasestorage.app",
            messagingSenderId: "410226513632",
            appId: "1:410226513632:web:521162e0dcc71e93432285",
            measurementId: "G-LX8YKZL8MY",
            databaseURL: "https://diyarbakir-tenis-default-rtdb.firebaseio.com/" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. UYGULAMA KODLARI ---
        const { useState, useEffect, useMemo, useRef } = React;

        // ƒ∞KONLAR
        const Icon = ({ name, size = 20, className }) => {
            const i = {
                ChartPie: <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/>,
                Settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
                Key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                UserCheck: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></>,
                UserX: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12"/>,
                ChevronLeft: <polyline points="15 18 9 12 15 6"/>,
                ChevronRight: <polyline points="9 18 15 12 9 6"/>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                UserSquare: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="12" cy="10" r="3"/><path d="M7 21v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
                Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
                Info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                UserPlus: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>,
                Mail: <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
                CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
                Square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>,
                Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{i[name]}</svg>;
        };

        const getStatusColor = (s) => s === 'present' ? 'bg-lime-500' : s === 'absent' ? 'bg-red-500' : 'bg-gray-200';

        // --- ANA UYGULAMA ---
        const App = () => {
            // FIREBASE VERƒ∞LERƒ∞
            const [groups, setGroups] = useState([]);
            const [definedCoaches, setDefinedCoaches] = useState([]);
            const [registeredStudents, setRegisteredStudents] = useState([]);
            const [appLogo, setAppLogo] = useState("https://cdn-icons-png.flaticon.com/512/33/33736.png");
            const [adminPassword, setAdminPassword] = useState("2121");

            // VERƒ∞LERƒ∞ √áEK
            useEffect(() => {
                db.ref('groups').on('value', s => setGroups(s.val() ? Object.values(s.val()) : []));
                db.ref('coaches').on('value', s => setDefinedCoaches(s.val() ? Object.values(s.val()) : []));
                db.ref('students').on('value', s => setRegisteredStudents(s.val() ? Object.values(s.val()) : []));
                db.ref('logo').on('value', s => { if(s.val()) setAppLogo(s.val()); });
                db.ref('adminPass').on('value', s => { if(s.val()) setAdminPassword(s.val()); });
            }, []);

            const [userRole, setUserRole] = useState(() => { const s = localStorage.getItem('dtk_session_v6'); return s ? JSON.parse(s).role : null; });
            const [currentCoach, setCurrentCoach] = useState(() => { const s = localStorage.getItem('dtk_session_v6'); return s ? JSON.parse(s).name : null; });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeGroup, setActiveGroup] = useState(null);
            
            // MODAL & UI STATES
            const [loginModalType, setLoginModalType] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCoachModalOpen, setIsCoachModalOpen] = useState(false);
            const [isStudentModalOpen, setIsStudentModalOpen] = useState(false);
            const [isAddExistingStudentModalOpen, setIsAddExistingStudentModalOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: '', onConfirm: null });
            const [viewingProfileStudent, setViewingProfileStudent] = useState(null);
            const [adminTab, setAdminTab] = useState('schedule');
            const [coachTab, setCoachTab] = useState('schedule');

            // FORM STATES
            const [newGroupName, setNewGroupName] = useState("");
            const [newCoachName, setNewCoachName] = useState("");
            const [tempSchedule, setTempSchedule] = useState([]);
            const [tempDay, setTempDay] = useState("Cumartesi");
            const [tempTime, setTempTime] = useState("11:00");
            const [newInstName, setNewInstName] = useState("");
            const [newInstEmail, setNewInstEmail] = useState("");
            const [newStudentName, setNewStudentName] = useState("");
            const [newStudentAge, setNewStudentAge] = useState("");
            const [newStudentPhone, setNewStudentPhone] = useState("");
            const [newStudentPhoto, setNewStudentPhoto] = useState(null);
            const [selectedGroupIdForStudent, setSelectedGroupIdForStudent] = useState("");
            const [targetGroupForAdd, setTargetGroupForAdd] = useState(null);
            const [selectedMemberIds, setSelectedMemberIds] = useState([]);
            const [editingGroup, setEditingGroup] = useState(null);
            const [changePassData, setChangePassData] = useState({ current: '', new: '', confirm: '' });

            const validHours = ["11:00", "12:00", "13:00", "14:00", "15:00", "16:00"];

            // ACTIONS
            const askConfirmation = (msg, action) => setConfirmModal({ isOpen: true, message: msg, onConfirm: action });
            const executeConfirm = () => { if(confirmModal.onConfirm) confirmModal.onConfirm(); setConfirmModal({isOpen:false, message:'', onConfirm:null}); };
            const handleLogout = () => { setUserRole(null); setCurrentCoach(null); localStorage.removeItem('dtk_session_v6'); };

            // FIREBASE ACTIONS
            const handleSaveGroup = (e) => {
                e.preventDefault(); if(tempSchedule.length===0){alert("Saat ekle!");return;}
                if(editingGroup) db.ref(`groups/${editingGroup.id}`).update({ name: newGroupName, instructor: newCoachName, schedule: tempSchedule });
                else { const id = Date.now(); db.ref(`groups/${id}`).set({ id, name: newGroupName, instructor: newCoachName, schedule: tempSchedule, players: [] }); }
                setIsModalOpen(false); setEditingGroup(null); setNewGroupName(""); setTempSchedule([]);
            };
            const handleDeleteGroup = (id, e) => { e.stopPropagation(); askConfirmation("Silmek istiyor musun?", () => db.ref(`groups/${id}`).remove()); };
            
            const handleAddCoach = (e) => { e.preventDefault(); if(definedCoaches.some(c=>c.email===newInstEmail)) return alert("Kayƒ±tlƒ±!"); const id=Date.now(); db.ref(`coaches/${id}`).set({id, name:newInstName, email:newInstEmail, password:null}); setIsCoachModalOpen(false); setNewInstName(""); setNewInstEmail(""); };
            const handleDeleteCoach = (id) => askConfirmation("Sil?", ()=>db.ref(`coaches/${id}`).remove());
            const handleResetCoachPassword = (id) => askConfirmation("≈ûifre 1234 olsun mu?", ()=>{db.ref(`coaches/${id}`).update({password:"1234"}); alert("Sƒ±fƒ±rlandƒ±.");});

            const handlePhotoChange = (e) => { const f=e.target.files[0]; if(f){const r=new FileReader(); r.onloadend=()=>setNewStudentPhoto(r.result); r.readAsDataURL(f);} };
            const handleAddStudentGlobal = (e) => {
                e.preventDefault(); if(!newStudentName.trim()) return;
                const id=Date.now(); const s={id, name:newStudentName, age:newStudentAge, phone:newStudentPhone, photo:newStudentPhoto};
                db.ref(`students/${id}`).set(s);
                if(selectedGroupIdForStudent) { const g=groups.find(x=>x.id==selectedGroupIdForStudent); if(g) db.ref(`groups/${g.id}`).update({players:[...(g.players||[]), s]}); }
                setIsStudentModalOpen(false); setNewStudentName(""); setNewStudentPhoto(null); setSelectedGroupIdForStudent("");
            };
            const handleDeleteStudentFromRegistry = (id) => askConfirmation("√ñƒürenciyi sil?", () => {
                db.ref(`students/${id}`).remove();
                groups.forEach(g=>{ if(g.players?.some(p=>p.id===id)) db.ref(`groups/${g.id}`).update({players: g.players.filter(p=>p.id!==id)}); });
            });

            const handleAddPlayerFromDetail = (e) => {
                e.preventDefault(); if(!newStudentName.trim()) return;
                const id=Date.now(); const s={id, name:newStudentName, age:newStudentAge, phone:newStudentPhone, photo:null};
                if(!registeredStudents.some(r=>r.id===id)) db.ref(`students/${id}`).set(s);
                const g=groups.find(x=>x.id===activeGroup.id);
                if(g) db.ref(`groups/${g.id}`).update({players:[...(g.players||[]), s]});
                setNewStudentName("");
            };
            const handleRemovePlayerFromGroup = (gid, pid) => askConfirmation("Gruptan √ßƒ±kar?", () => {
                const g=groups.find(x=>x.id===gid);
                if(g) { const np=g.players.filter(p=>p.id!==pid); db.ref(`groups/${gid}`).update({players:np}); if(activeGroup && activeGroup.id===gid) setActiveGroup({...g, players:np}); }
            });
            const handleAddMultipleExistingStudents = (e) => {
                e.preventDefault(); const g=groups.find(x=>x.id===targetGroupForAdd.id);
                if(g && selectedMemberIds.length>0) {
                    const np=[...(g.players||[])];
                    selectedMemberIds.forEach(sid=>{ const s=registeredStudents.find(x=>x.id===sid); if(s && !np.some(p=>p.id===sid)) np.push(s); });
                    db.ref(`groups/${g.id}`).update({players:np});
                }
                setIsAddExistingStudentModalOpen(false); setSelectedMemberIds([]);
            };

            const toggleAttendance = (pid, status) => {
                const g=groups.find(x=>x.id===activeGroup.id);
                if(g) {
                    const cur = g.records?.[selectedDate]?.[pid];
                    const val = cur === status ? null : status;
                    if(val===null) db.ref(`groups/${g.id}/records/${selectedDate}/${pid}`).remove();
                    else db.ref(`groups/${g.id}/records/${selectedDate}/${pid}`).set(val);
                }
            };

            const handleLogoUpdate = (u) => db.ref('logo').set(u);
            const handleChangeAdminPassword = (e) => { e.preventDefault(); if(changePassData.current!==adminPassword) return alert("Yanlƒ±≈ü!"); if(changePassData.new!==changePassData.confirm) return alert("Uyu≈ümuyor!"); db.ref('adminPass').set(changePassData.new); setIsSettingsOpen(false); alert("Deƒüi≈üti."); };

            // COMPONENTS
            const LoginComp = () => {
                const [s, setS]=useState('email'); const [m, setM]=useState(''); const [p, setP]=useState(''); const [err, setErr]=useState(''); const [found, setFound]=useState(null);
                useEffect(()=>{setS('email'); setM(''); setP(''); setErr('');}, [loginModalType]);
                const login = (e) => {
                    e.preventDefault();
                    if(loginModalType==='admin') { if(p===adminPassword){setUserRole('admin'); localStorage.setItem('dtk_session_v6', JSON.stringify({role:'admin'})); setLoginModalType(null);} else setErr('Hatalƒ± ≈üifre'); }
                    else {
                        if(s==='email') { const c=definedCoaches.find(x=>x.email===m); if(c){setFound(c); setS(c.password?'password':'set'); setErr('');} else setErr('Bulunamadƒ±'); }
                        else if(s==='password') { if(found.password===p){setUserRole('coach'); setCurrentCoach(found.name); localStorage.setItem('dtk_session_v6', JSON.stringify({role:'coach',name:found.name})); setLoginModalType(null);} else setErr('Yanlƒ±≈ü'); }
                        else { db.ref(`coaches/${found.id}`).update({password:p}); setUserRole('coach'); setCurrentCoach(found.name); localStorage.setItem('dtk_session_v6', JSON.stringify({role:'coach',name:found.name})); setLoginModalType(null); }
                    }
                };
                if(!loginModalType) return null;
                return <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50"><div className="glass-modal rounded-[32px] p-8 w-full max-w-sm relative"><button onClick={()=>setLoginModalType(null)} className="absolute top-4 right-4 font-bold">‚úï</button><h2 className="text-2xl font-black text-center mb-6">{loginModalType==='admin'?'Y√∂netici':'Antren√∂r'} Giri≈üi</h2><form onSubmit={login} className="space-y-4">{loginModalType==='coach' && s==='email' && <input className="w-full border-2 p-3 rounded-xl" placeholder="Email" value={m} onChange={e=>setM(e.target.value)} required type="email"/>}{(loginModalType==='admin' || s!=='email') && <input className="w-full border-2 p-3 rounded-xl" placeholder="≈ûifre" type="password" value={p} onChange={e=>setP(e.target.value)} autoFocus/>}<button className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Giri≈ü Yap</button>{err && <p className="text-red-500 text-center">{err}</p>}</form></div></div>;
            };

            const ReportsView = () => {
                const m=new Date().getMonth(), y=new Date().getFullYear();
                const total=useMemo(()=>{let c=0; groups.forEach(g=>{if(g.records)Object.keys(g.records).forEach(d=>{if(new Date(d).getMonth()===m)c++;});});return c;},[groups]);
                const top=useMemo(()=>{const l=[]; registeredStudents.forEach(s=>{let p=0; groups.forEach(g=>{if(g.players?.some(x=>x.id===s.id) && g.records) Object.values(g.records).forEach(r=>{if(r[s.id]==='present')p++;});}); if(p>0)l.push({...s, p});}); return l.sort((a,b)=>b.p-a.p).slice(0,5);},[groups, registeredStudents]);
                const risky=useMemo(()=>{const r=[]; registeredStudents.forEach(s=>{let t=0, a=0; groups.forEach(g=>{if(g.players?.some(x=>x.id===s.id) && g.records) Object.values(g.records).forEach(rec=>{if(rec[s.id]){t++; if(rec[s.id]==='absent')a++;}});}); if(t>2 && (a/t)>0.3) r.push({...s, ratio:Math.round((a/t)*100), a, t});}); return r.sort((a,b)=>b.ratio-a.ratio);},[groups, registeredStudents]);
                
                return <div className="p-4 space-y-4 pb-32"><div className="glass-card p-6 rounded-3xl border-l-8 border-lime-400 flex justify-between"><div><div className="text-xs text-gray-500 font-bold">BU AY</div><div className="text-4xl font-black">{total}</div></div><div className="text-right text-xs text-gray-400">DERS</div></div><div className="glass-card p-6 rounded-3xl"><h3 className="font-black mb-4 flex gap-2"><Icon name="Star" className="text-yellow-500"/> EN √áALI≈ûKANLAR</h3>{top.map((s,i)=><div key={i} className="flex justify-between p-2 border-b"><span>{i+1}. {s.name}</span><span className="font-bold text-emerald-600">{s.p} Ders</span></div>)}</div><div className="glass-card p-6 rounded-3xl border-l-8 border-red-400"><h3 className="font-black mb-4 flex gap-2"><Icon name="AlertCircle" className="text-red-500"/> DEVAMSIZLIK Rƒ∞SKƒ∞</h3>{risky.map((s,i)=><div key={i} className="flex justify-between p-2 border-b"><span>{s.name}</span><span className="font-bold text-red-500">%{s.ratio} ({s.a}/{s.t})</span></div>)}</div></div>;
            };

            // RENDER LOGIC
            if(!userRole) return <><WelcomeScreen onAdminClick={()=>setLoginModalType('admin')} onCoachClick={()=>setLoginModalType('coach')} logoUrl={appLogo}/><LoginComp/></>;
            const curDay = new Intl.DateTimeFormat('tr-TR', { weekday: 'long' }).format(new Date(selectedDate));
            const dailyGroups = groups.filter(g => g.schedule?.some(s => s.day === curDay));

            return (
                <div className="min-h-screen bg-tennis-court flex flex-col relative">
                    <Header title={activeGroup ? activeGroup.name : "Diyarbakƒ±r Tenis Kul√ºb√º"} showBack={!!activeGroup} onBack={()=>setActiveGroup(null)} userRole={userRole} currentCoach={currentCoach} onShowLogin={()=>setLoginModalType('admin')} onLogout={handleLogout} logoUrl={appLogo} onLogoUpdate={handleLogoUpdate} onOpenSettings={()=>setIsSettingsOpen(true)}/>
                    <div className="flex-1 overflow-y-auto">
                        {activeGroup ? (
                            <div className="p-4">
                                <div className="glass-card p-4 rounded-3xl mb-4"><h2 className="text-xl font-black">{activeGroup.instructor}</h2><div className="text-sm text-gray-500">{curDay}</div></div>
                                {userRole==='admin' && <div className="mb-4"><form onSubmit={handleAddPlayerFromDetail} className="flex gap-2"><input value={newStudentName} onChange={e=>setNewStudentName(e.target.value)} placeholder="Hƒ±zlƒ± Ekle..." className="flex-1 p-3 rounded-xl border"/><button className="bg-emerald-600 text-white p-3 rounded-xl">+</button></form></div>}
                                <div className="space-y-2">{(activeGroup.players||[]).map(p=>{const st=activeGroup.records?.[selectedDate]?.[p.id]; return <div key={p.id} className="glass-card p-3 rounded-xl flex justify-between items-center" onClick={()=>setViewingProfileStudent(p)}><div className="flex items-center gap-3"><div className={`w-3 h-3 rounded-full ${getStatusColor(st)}`}></div><span className="font-bold">{p.name}</span></div><div className="flex gap-2" onClick={e=>e.stopPropagation()}><button onClick={()=>toggleAttendance(p.id,'present')} className="p-2 border rounded-lg hover:bg-lime-100">‚úÖ</button><button onClick={()=>toggleAttendance(p.id,'absent')} className="p-2 border rounded-lg hover:bg-red-100">‚ùå</button>{userRole==='admin' && <button onClick={()=>handleRemovePlayerFromGroup(activeGroup.id,p.id)} className="p-2 border rounded-lg text-red-500">üóë</button>}</div></div>})}</div>
                            </div>
                        ) : (
                            <>
                                <HorizontalCalendar selectedDate={selectedDate} onSelectDate={setSelectedDate}/>
                                {adminTab==='reports' ? <ReportsView/> : <div className="p-4 pb-24 space-y-4">
                                    {adminTab==='schedule' && dailyGroups.map(g=><div key={g.id} onClick={()=>setActiveGroup(g)} className="glass-card p-5 rounded-3xl relative"><div className="absolute top-0 right-0 bg-emerald-100 px-3 py-1 rounded-bl-xl text-xs font-bold">{g.schedule?.find(s=>s.day===curDay)?.time}</div><h3 className="text-lg font-black">{g.name}</h3><div className="text-sm text-emerald-600 font-bold">{g.instructor}</div><div className="mt-2 text-xs text-gray-500">{g.players?.length||0} Oyuncu</div></div>)}
                                    {adminTab==='groups' && groups.map(g=><div key={g.id} className="glass-card p-4 rounded-2xl flex justify-between items-center"><span>{g.name}</span><div className="flex gap-2"><button onClick={(e)=>openEditGroupModal(g,e)} className="p-2 bg-blue-100 rounded">‚úèÔ∏è</button><button onClick={(e)=>handleDeleteGroup(g.id,e)} className="p-2 bg-red-100 rounded">üóë</button></div></div>)}
                                    {adminTab==='coaches' && definedCoaches.map(c=><div key={c.id} className="glass-card p-4 rounded-2xl flex justify-between items-center"><span>{c.name}</span><button onClick={()=>handleDeleteCoach(c.id)} className="p-2 bg-red-100 rounded">üóë</button></div>)}
                                    {adminTab==='students' && registeredStudents.map(s=><div key={s.id} className="glass-card p-4 rounded-2xl flex justify-between items-center"><span>{s.name}</span><button onClick={()=>handleDeleteStudentFromRegistry(s.id)} className="p-2 bg-red-100 rounded">üóë</button></div>)}
                                </div>}
                            </>
                        )}
                    </div>
                    {/* MENUS & MODALS */}
                    {userRole==='admin' && !activeGroup && (
                        <>
                            <div className="fixed bottom-24 right-4 flex flex-col gap-2">{adminTab==='groups'&&<button onClick={()=>setIsModalOpen(true)} className="bg-lime-500 text-white p-4 rounded-full shadow-lg text-2xl">+</button>}{adminTab==='coaches'&&<button onClick={()=>setIsCoachModalOpen(true)} className="bg-orange-500 text-white p-4 rounded-full shadow-lg text-2xl">+</button>}{adminTab==='students'&&<button onClick={()=>setIsStudentModalOpen(true)} className="bg-emerald-600 text-white p-4 rounded-full shadow-lg text-2xl">+</button>}</div>
                            <div className="floating-nav p-2 fixed bottom-4 left-4 right-4 flex justify-between shadow-xl z-20 pb-safe backdrop-blur-lg"><button onClick={()=>setAdminTab('schedule')} className={`p-2 flex-1 flex flex-col items-center ${adminTab==='schedule'?'text-emerald-700 font-bold':''}`}><Icon name="Calendar"/><span className="text-[10px]">Program</span></button><button onClick={()=>setAdminTab('groups')} className={`p-2 flex-1 flex flex-col items-center ${adminTab==='groups'?'text-emerald-700 font-bold':''}`}><Icon name="Layers"/><span className="text-[10px]">Gruplar</span></button><button onClick={()=>setAdminTab('students')} className={`p-2 flex-1 flex flex-col items-center ${adminTab==='students'?'text-emerald-700 font-bold':''}`}><Icon name="Users"/><span className="text-[10px]">√ñƒürenci</span></button><button onClick={()=>setAdminTab('coaches')} className={`p-2 flex-1 flex flex-col items-center ${adminTab==='coaches'?'text-emerald-700 font-bold':''}`}><Icon name="UserSquare"/><span className="text-[10px]">Hoca</span></button><button onClick={()=>setAdminTab('reports')} className={`p-2 flex-1 flex flex-col items-center ${adminTab==='reports'?'text-emerald-700 font-bold':''}`}><Icon name="ChartPie"/><span className="text-[10px]">Rapor</span></button></div>
                        </>
                    )}
                    {userRole==='coach' && !activeGroup && <div className="floating-nav p-2 fixed bottom-4 left-4 right-4 flex justify-around shadow-xl z-20 pb-safe backdrop-blur-lg"><button onClick={()=>setCoachTab('schedule')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${coachTab==='schedule'?'text-emerald-700 font-bold':''}`}><Icon name="Calendar"/><span className="text-[10px]">Programƒ±m</span></button><button onClick={()=>setCoachTab('students')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${coachTab==='students'?'text-emerald-700 font-bold':''}`}><Icon name="Users"/><span className="text-[10px]">√ñƒürenciler</span></button></div>}
                    
                    {/* SETTINGS MODAL */}
                    {isSettingsOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="glass-modal rounded-[32px] p-6 w-80"><h3 className="font-bold mb-4">Ayarlar</h3><div className="mb-4"><h4 className="text-sm font-bold mb-2">≈ûifre Deƒüi≈ütir</h4><input className="w-full border p-2 rounded mb-2" placeholder="Mevcut" value={changePassData.current} onChange={e=>setChangePassData({...changePassData,current:e.target.value})}/><input className="w-full border p-2 rounded mb-2" placeholder="Yeni" value={changePassData.new} onChange={e=>setChangePassData({...changePassData,new:e.target.value})}/><input className="w-full border p-2 rounded" placeholder="Tekrar" value={changePassData.confirm} onChange={e=>setChangePassData({...changePassData,confirm:e.target.value})}/><button onClick={handleChangeAdminPassword} className="w-full bg-blue-500 text-white p-2 rounded mt-2">G√ºncelle</button></div><button className="w-full bg-gray-200 p-3 rounded-xl" onClick={()=>setIsSettingsOpen(false)}>Kapat</button></div></div>}
                    
                    {/* ADD GROUP MODAL */}
                    {isModalOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50"><div className="glass-modal rounded-[32px] p-6 w-80"><h3 className="font-bold mb-4">Grup Olu≈ütur</h3><input className="w-full border p-2 mb-2 rounded" placeholder="Grup Adƒ±" value={newGroupName} onChange={e=>setNewGroupName(e.target.value)}/><select className="w-full border p-2 mb-2 rounded" value={newCoachName} onChange={e=>setNewCoachName(e.target.value)}><option value="">Hoca Se√ß</option>{definedCoaches.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}</select><div className="flex gap-2 mb-4"><select className="border p-1 rounded" value={tempDay} onChange={e=>setTempDay(e.target.value)}><option>Pazartesi</option><option>Salƒ±</option><option>√áar≈üamba</option><option>Per≈üembe</option><option>Cuma</option><option>Cumartesi</option><option>Pazar</option></select><select className="border p-1 rounded" value={tempTime} onChange={e=>setTempTime(e.target.value)}>{validHours.map(h=><option key={h}>{h}</option>)}</select><button onClick={()=>setTempSchedule([...tempSchedule,{day:tempDay,time:tempTime}])} className="bg-blue-100 p-1 rounded">+</button></div><div className="mb-4 text-xs">{tempSchedule.map((s,i)=><div key={i}>{s.day} {s.time}</div>)}</div><button onClick={handleSaveGroup} className="w-full bg-emerald-600 text-white p-3 rounded-xl">Kaydet</button><button onClick={()=>setIsModalOpen(false)} className="w-full mt-2 text-gray-500">ƒ∞ptal</button></div></div>}
                    
                    {/* OTHER MODALS */}
                    {isCoachModalOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50"><div className="glass-modal rounded-[32px] p-6 w-80"><h3 className="font-bold mb-4">Hoca Ekle</h3><input className="w-full border p-2 mb-2 rounded" placeholder="Ad" value={newInstName} onChange={e=>setNewInstName(e.target.value)}/><input className="w-full border p-2 mb-4 rounded" placeholder="Email" value={newInstEmail} onChange={e=>setNewInstEmail(e.target.value)}/><button onClick={handleAddCoach} className="w-full bg-orange-500 text-white p-3 rounded-xl">Ekle</button><button onClick={()=>setIsCoachModalOpen(false)} className="w-full mt-2 text-gray-500">ƒ∞ptal</button></div></div>}
                    {isStudentModalOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50"><div className="glass-modal rounded-[32px] p-6 w-80"><h3 className="font-bold mb-4">√ñƒürenci Ekle</h3><div className="flex justify-center mb-4"><div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center relative overflow-hidden"><input type="file" onChange={handlePhotoChange} className="absolute inset-0 opacity-0"/><span className="text-xs text-gray-400">Foto</span>{newStudentPhoto&&<img src={newStudentPhoto} className="absolute inset-0 w-full h-full object-cover"/>}</div></div><input className="w-full border p-2 mb-2 rounded" placeholder="Ad" value={newStudentName} onChange={e=>setNewStudentName(e.target.value)}/><input className="w-full border p-2 mb-2 rounded" placeholder="Ya≈ü" type="number" value={newStudentAge} onChange={e=>setNewStudentAge(e.target.value)}/><input className="w-full border p-2 mb-4 rounded" placeholder="Tel" type="tel" value={newStudentPhone} onChange={e=>setNewStudentPhone(e.target.value)}/><select className="w-full border p-2 mb-4 rounded" value={selectedGroupIdForStudent} onChange={e=>setSelectedGroupIdForStudent(e.target.value)}><option value="">Grup Se√ß (Opsiyonel)</option>{groups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select><button onClick={handleAddStudentGlobal} className="w-full bg-emerald-600 text-white p-3 rounded-xl">Ekle</button><button onClick={()=>setIsStudentModalOpen(false)} className="w-full mt-2 text-gray-500">ƒ∞ptal</button></div></div>}
                    
                    <ConfirmationDialog isOpen={confirmModal.isOpen} message={confirmModal.message} onConfirm={executeConfirm} onCancel={() => setConfirmModal({isOpen:false, message:'', onConfirm:null})} />
                    {viewingProfileStudent && <StudentProfileModal student={viewingProfileStudent} groups={groups} onClose={()=>setViewingProfileStudent(null)}/>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>