<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diyarbakır Tenis Kulübü</title>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#065f46">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            if(msg.indexOf("Script error") === -1) console.error("App Error:", msg);
        };
    </script>
</head>
<body class="bg-emerald-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyCsOde5aNv6HnNJMXtPLlGisXF_zXp3E5o",
          authDomain: "diyarbakirtenis-254b1.firebaseapp.com",
          projectId: "diyarbakirtenis-254b1",
          storageBucket: "diyarbakirtenis-254b1.firebasestorage.app",
          messagingSenderId: "664290250808",
          appId: "1:664290250808:web:bd0ff27083ea50f145d6cd",
          measurementId: "G-LL1R6KD89Q"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.firebaseAuth = getAuth(app);
            window.firebaseDb = getFirestore(app);
            window.firebaseUtils = { 
                signInWithEmailAndPassword, createUserWithEmailAndPassword, firebaseSignOut, 
                onAuthStateChanged, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where 
            };
        } catch(e) { console.error("Firebase Init Error:", e); }

        // --- CSS STİLLERİ (CAM TASARIM - ORİJİNAL) ---
        const styles = `
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Righteous&display=swap');
            
            body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
            .font-sport { font-family: 'Righteous', cursive; }
            
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            .logo-container { width: 40px; height: 40px; overflow: hidden; border-radius: 50%; border: 2px solid #bef264; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            .student-photo-sm { width: 36px; height: 36px; overflow: hidden; border-radius: 50%; border: 2px solid #fff; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .logo-img { width: 100%; height: 100%; object-fit: cover; }
            .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
            @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
            
            .bg-tennis-court {
                background-image: linear-gradient(to bottom, rgba(240, 253, 244, 0.9), rgba(240, 253, 244, 0.95)), url('https://images.unsplash.com/photo-1575361204480-aadea2534679?q=80&w=2070&auto=format&fit=crop');
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
            }
            .glass-card {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            }
            .glass-modal {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .welcome-bg {
                 background-image: linear-gradient(to bottom, rgba(6, 95, 70, 0.8), rgba(6, 78, 59, 0.9)), url('https://images.unsplash.com/photo-1622163642998-1ea36b1ad565?q=80&w=1974&auto=format&fit=crop');
                 background-size: cover;
                 background-position: center;
            }
            .floating-nav {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-top: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
                border-radius: 24px 24px 0 0;
                margin: 0 10px;
            }
        `;

        const { useState, useEffect, useMemo, useRef } = React;

        // --- İKONLAR ---
        const Icon = ({ name, size = 20, className }) => {
            const icons = {
                ChartPie: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>,
                Settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
                Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                UserCheck: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></>,
                UserX: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Minus: <><line x1="5" y1="12" x2="19" y2="12"/></>,
                ChevronLeft: <polyline points="15 18 9 12 15 6"/>,
                ChevronRight: <polyline points="9 18 15 12 9 6"/>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                UserSquare: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="12" cy="10" r="3"/><path d="M7 21v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                Layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
                Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                Phone: <><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></>,
                Info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                UserPlus: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>,
                Mail: <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
                CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
                Square: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></>,
                Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        const getDayNameFromDate = (dateStr) => {
            const date = new Date(dateStr);
            const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            return days[date.getDay()];
        };
        const getStatusColor = (status) => status === 'present' ? 'bg-lime-500' : status === 'absent' ? 'bg-red-500' : 'bg-gray-200';
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();

        // --- Header Bileşeni ---
        const Header = ({ title, showBack = false, onBack, userRole, currentCoach, onShowLogin, onLogout, logoUrl, onLogoUpdate, onOpenSettings }) => {
            const fileInputRef = useRef(null);
            const handleLogoClick = () => { if(userRole === 'admin' && fileInputRef.current) fileInputRef.current.click(); };
            const handleFileChange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = () => onLogoUpdate(reader.result); reader.readAsDataURL(file); } };
            return (
                <div className="bg-emerald-900/90 backdrop-blur-md p-4 text-white shadow-lg flex justify-between items-center sticky top-0 z-30 border-b border-white/10">
                    <div className="flex items-center gap-3">
                        {showBack ? ( <button onClick={onBack} className="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-colors"><Icon name="ChevronLeft" size={24} /></button> ) : (
                            <div onClick={handleLogoClick} className={`logo-container bg-white flex items-center justify-center shadow-lg ${userRole === 'admin' ? 'cursor-pointer hover:opacity-80' : ''}`}>
                                <img src={logoUrl || "https://cdn-icons-png.flaticon.com/512/33/33736.png"} alt="Logo" className="logo-img" />
                                {userRole === 'admin' && <div className="absolute inset-0 bg-black/30 flex items-center justify-center text-white opacity-0 hover:opacity-100"><Icon name="Camera" size={16} /></div>}
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                            </div>
                        )}
                        <div><h1 className="text-lg font-bold leading-tight tracking-tight font-sport">{title}</h1>{!showBack && <p className="text-[10px] text-emerald-200 uppercase tracking-wider font-medium">{userRole === 'admin' ? 'YÖNETİCİ MODU' : userRole === 'coach' ? `ANTRENÖR: ${currentCoach ? currentCoach.toUpperCase() : ''}` : 'MİSAFİR MODU'}</p>}</div>
                    </div>
                    <div className="flex gap-2">
                        {userRole === 'admin' && ( <button onClick={onOpenSettings} className="p-2 rounded-full bg-emerald-800/50 text-white border border-white/20 shadow hover:bg-emerald-700/50 backdrop-blur-sm" title="Ayarlar"><Icon name="Settings" size={20} /></button> )}
                        {userRole === 'guest' ? ( <button onClick={onShowLogin} className="p-2 rounded-full bg-emerald-900 border-emerald-700 text-emerald-400 border-2"><Icon name="Lock" size={20} /></button> ) : ( <button onClick={onLogout} className="p-2 rounded-full bg-red-500/80 text-white border border-red-400 shadow hover:bg-red-600/80 backdrop-blur-sm" title="Çıkış Yap"><Icon name="LogOut" size={20} /></button> )}
                    </div>
                </div>
            );
        };

        const HorizontalCalendar = ({ selectedDate, onSelectDate }) => {
            const days = useMemo(() => { const r=[]; const c=new Date(selectedDate); for(let i=-14;i<=14;i++) { const d=new Date(c); d.setDate(c.getDate()+i); if(d.getDay()===0||d.getDay()===6) r.push(d); } return r.sort((a,b)=>a-b); }, [selectedDate]);
            return (
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-4 px-4 bg-emerald-900/90 backdrop-blur-md text-white shadow-inner border-b border-white/10">
                    {days.map((date, idx) => {
                        const dateStr = date.toISOString().split('T')[0]; const isSelected = dateStr === selectedDate; const d = new Date(dateStr); const dayName = new Intl.DateTimeFormat('tr-TR', { weekday: 'short' }).format(d); const dayNum = d.getDate(); const monthName = new Intl.DateTimeFormat('tr-TR', { month: 'short' }).format(d); const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                        return (
                            <button key={idx} onClick={() => onSelectDate(dateStr)} className={`flex flex-col items-center justify-center min-w-[58px] p-2 rounded-2xl transition-all border ${isSelected ? 'bg-lime-400 text-emerald-900 font-bold shadow-lg scale-105 border-lime-300' : 'hover:bg-white/10 text-emerald-100 border-transparent'} ${isWeekend && !isSelected ? 'border-b-4 border-b-yellow-400/50' : ''}`}>
                                <span className="text-[10px] uppercase opacity-80 font-medium">{dayName}</span><span className="text-xl font-black tracking-tight">{dayNum}</span><span className="text-[9px] opacity-70 uppercase font-medium">{monthName}</span>
                            </button>
                        );
                    })}
                </div>
            );
        };

        const ConfirmationDialog = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-[60] animate-[fadeIn_0.1s_ease-out]">
                    <div className="glass-modal rounded-3xl shadow-2xl w-full max-w-xs overflow-hidden p-6 text-center">
                        <div className="bg-red-100/80 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 shadow-sm"><Icon name="AlertCircle" size={32}/></div>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">Emin misiniz?</h3>
                        <p className="text-sm text-gray-600 mb-6 leading-relaxed font-medium">{message}</p>
                        <div className="flex gap-3"><button onClick={onCancel} className="flex-1 py-3 bg-gray-100/80 text-gray-700 rounded-2xl font-bold hover:bg-gray-200/80 transition-colors">İptal</button><button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-2xl font-bold hover:bg-red-600 shadow-md transition-colors">Evet</button></div>
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ onAdminClick, onCoachClick, logoUrl }) => (
            <div className="min-h-screen welcome-bg flex flex-col items-center justify-center p-6 relative overflow-hidden">
                <div className="absolute inset-0 bg-black/30"></div>
                <div className="glass-card p-8 rounded-[40px] w-full max-w-sm shadow-2xl animate-slide-up flex flex-col items-center z-10 border-t-white/50">
                    <div className="bg-white p-4 rounded-full shadow-xl mb-6 ring-4 ring-white/30"><img src={logoUrl || "https://cdn-icons-png.flaticon.com/512/33/33736.png"} alt="Logo" className="w-28 h-28 object-cover rounded-full" /></div>
                    <h1 className="text-4xl font-black text-white text-center mb-2 drop-shadow-lg tracking-tight font-sport">Diyarbakır</h1>
                    <h2 className="text-xl font-bold text-lime-300 text-center mb-10 tracking-[0.2em] drop-shadow font-sport">TENİS KULÜBÜ</h2>
                    <div className="w-full space-y-4">
                        <button onClick={onCoachClick} className="w-full bg-lime-500 hover:bg-lime-400 text-emerald-900 font-bold py-4 px-6 rounded-3xl transition-all transform hover:scale-[1.02] shadow-lg flex items-center justify-center gap-3 text-lg"><Icon name="UserSquare" size={24} /> ANTRENÖR GİRİŞİ</button>
                        <button onClick={onAdminClick} className="w-full bg-lime-500 hover:bg-lime-400 text-black font-bold py-4 px-6 rounded-3xl transition-all transform hover:scale-[1.02] shadow-lg flex items-center justify-center gap-3 text-lg border-2 border-transparent"><Icon name="Lock" size={20} /> YÖNETİCİ GİRİŞİ</button>
                    </div>
                    <p className="mt-10 text-white/70 text-xs font-medium">© 2025 DTK App Premium</p>
                </div>
            </div>
        );

        const StudentProfileModal = ({ student, groups, onClose }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const changeMonth = (offset) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + offset); setViewDate(d); };
            const year = viewDate.getFullYear(); const month = viewDate.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = new Date(year, month, 1).getDay(); const startingSlot = firstDay === 0 ? 6 : firstDay - 1;
            
            const detailedRecords = useMemo(() => {
                const details = [];
                groups.forEach(g => {
                    if((g.players||[]).some(pl => pl.id === student.id)) {
                        const records = g.records || {};
                        Object.entries(records).forEach(([ds, st]) => {
                            const s = st[student.id];
                            if(s) { const rd = new Date(ds); if(rd.getFullYear() === year && rd.getMonth() === month) details.push({ date: ds, status: s, groupName: g.name }); }
                        });
                    }
                });
                return details.sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [groups, student, year, month]);

            const pCount = detailedRecords.filter(r => r.status === 'present').length;
            const aCount = detailedRecords.filter(r => r.status === 'absent').length;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                    <div className="glass-modal rounded-3xl w-full max-w-sm overflow-hidden max-h-[80vh] flex flex-col shadow-2xl">
                        <div className="bg-emerald-800/90 p-5 text-white flex justify-between flex-shrink-0 items-center backdrop-blur-md">
                            <div className="flex items-center gap-4">{student.photo ? <img src={student.photo} className="w-14 h-14 rounded-full border-4 border-white/30 object-cover shadow-sm" /> : <div className="w-14 h-14 rounded-full bg-emerald-700 border-4 border-white/30 flex items-center justify-center font-bold text-xl">?</div>}<div><h2 className="text-2xl font-bold tracking-tight">{student.name}</h2><p className="text-sm opacity-90 font-medium flex items-center gap-2"><Icon name="Phone" size={14}/> {student.phone} | {student.age} Yaş</p></div></div>
                            <button onClick={onClose} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors"><Icon name="Minus" size={20}/></button>
                        </div>
                        <div className="p-5 overflow-y-auto bg-white/60 backdrop-blur-md flex-1">
                            <div className="flex gap-3 mb-6 text-center"><div className="flex-1 bg-lime-500/10 p-3 rounded-2xl border border-lime-500/30 shadow-sm"><div className="text-3xl font-black text-lime-600">{pCount}</div><div className="text-[10px] font-bold text-lime-700 uppercase tracking-wider">GELDİ</div></div><div className="flex-1 bg-red-500/10 p-3 rounded-2xl border border-red-500/30 shadow-sm"><div className="text-3xl font-black text-red-600">{aCount}</div><div className="text-[10px] font-bold text-red-700 uppercase tracking-wider">GELMEDİ</div></div></div>
                            <div className="flex justify-between mb-4 items-center bg-white/40 p-2 rounded-xl"><button onClick={() => changeMonth(-1)} className="p-1"><Icon name="ChevronLeft"/></button><span className="font-bold text-lg text-gray-800">{new Intl.DateTimeFormat('tr-TR', { month: 'long', year: 'numeric' }).format(viewDate)}</span><button onClick={() => changeMonth(1)} className="p-1"><Icon name="ChevronRight"/></button></div>
                            <div className="grid grid-cols-7 gap-2 text-center text-xs mb-2 font-bold text-gray-500 uppercase tracking-widest"><span>Pt</span><span>Sa</span><span>Ça</span><span>Pe</span><span>Cu</span><span>Ct</span><span>Pa</span></div>
                            <div className="grid grid-cols-7 gap-2 mb-6 p-2 bg-white/40 rounded-2xl">
                                {Array.from({length: startingSlot}).map((_, i) => <div key={`e-${i}`} />)}
                                {Array.from({length: daysInMonth}).map((_, i) => {
                                    const d = i + 1; const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const record = detailedRecords.find(r => r.date === dateStr); const status = record ? record.status : null;
                                    return <div key={d} className="aspect-square flex items-center justify-center rounded-xl font-bold text-sm border-2 border-transparent relative overflow-hidden text-gray-800"><span className="z-10">{d}</span>{status==='present'&&<div className="absolute inset-0 bg-lime-400 rounded-xl border-2 border-lime-500 opacity-80"></div>}{status==='absent'&&<div className="absolute inset-0 bg-red-400 rounded-xl border-2 border-red-500 opacity-80"></div>}</div>
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminReportsView = ({ groups, students }) => {
            const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
            const totalLessonsThisMonth = useMemo(() => { let count = 0; groups.forEach(g => { const records = g.records || {}; Object.keys(records).forEach(dateStr => { const d = new Date(dateStr); if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) count++; }); }); return count; }, [groups]);
            const topStudents = useMemo(() => { const list = []; students.forEach(s => { let present = 0; groups.forEach(g => { if((g.players||[]).some(p => p.id === s.id)) { const records = g.records || {}; Object.values(records).forEach(rec => { if(rec[s.id] === 'present') present++; }); } }); if(present > 0) list.push({ ...s, present }); }); return list.sort((a,b) => b.present - a.present).slice(0, 5); }, [students, groups]);
            const riskyStudents = useMemo(() => { const risks = []; students.forEach(s => { let total = 0; let absent = 0; groups.forEach(g => { if((g.players||[]).some(p => p.id === s.id)) { const records = g.records || {}; Object.values(records).forEach(rec => { if(rec[s.id]) { total++; if(rec[s.id] === 'absent') absent++; } }); } }); if(total > 2) { const ratio = absent / total; if(ratio > 0.3) risks.push({ ...s, ratio: Math.round(ratio * 100), total, absent }); } }); return risks.sort((a,b) => b.ratio - a.ratio); }, [students, groups]);

            return (
                <div className="p-4 space-y-6 pb-32">
                    <div className="glass-card p-6 rounded-3xl border-l-8 border-lime-400 flex items-center justify-between"><div><div className="text-gray-500 font-bold text-xs uppercase tracking-wider">BU AY YAPILAN</div><div className="text-4xl font-black text-gray-800 mt-1">TOPLAM DERS</div></div><div className="text-5xl font-black text-lime-600">{totalLessonsThisMonth}</div></div>
                    <div className="glass-card p-6 rounded-3xl"><h3 className="font-black text-gray-800 mb-4 flex items-center gap-2"><Icon name="Star" className="text-yellow-500"/> EN DEVAMLI ÖĞRENCİLER</h3><div className="space-y-3">{topStudents.length === 0 ? <p className="text-center text-gray-400 text-sm">Henüz veri yok.</p> : topStudents.map((s, i) => (<div key={i} className="flex items-center justify-between p-3 bg-white/60 rounded-xl border border-white/50"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-yellow-100 text-yellow-700 flex items-center justify-center font-bold text-sm">{i+1}</div><span className="font-bold text-gray-700">{s.name}</span></div><span className="font-black text-emerald-600 text-lg">{s.present} <span className="text-xs font-normal text-gray-400">Ders</span></span></div>))}</div></div>
                    <div className="glass-card p-6 rounded-3xl border-l-8 border-red-400"><h3 className="font-black text-gray-800 mb-4 flex items-center gap-2"><Icon name="AlertCircle" className="text-red-500"/> RİSKLİ ÖĞRENCİLER</h3><div className="space-y-3">{riskyStudents.length === 0 ? <p className="text-center text-gray-400 text-sm py-2">Riskli öğrenci yok. Harika!</p> : riskyStudents.map((s, i) => (<div key={i} className="flex items-center justify-between p-3 bg-red-50/50 rounded-xl border border-red-100"><div><div className="font-bold text-gray-800">{s.name}</div><div className="text-xs text-red-400 font-medium">{s.absent} devamsızlık / {s.total} ders</div></div><div className="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-black text-sm">%{s.ratio}</div></div>))}</div></div>
                </div>
            );
        };

        const AdminScheduleGrid = ({ dailyGroups, coaches, onGroupClick }) => (
            <div className="p-4 pb-36 overflow-x-auto">
                <div className="min-w-[800px] glass-card rounded-3xl overflow-hidden shadow-sm">
                    <div className="flex border-b border-gray-100/50 bg-gray-50/50 backdrop-blur-sm"><div className="w-20 flex-shrink-0 p-3 border-r border-gray-100/50 text-gray-400 font-bold text-xs text-center sticky left-0 z-10 bg-gray-50/90 backdrop-blur-md">SAAT</div>{coaches.map(inst => (<div key={inst.id} className="flex-1 p-3 border-r border-gray-100/50 text-emerald-800 font-bold text-xs text-center truncate tracking-wider uppercase">{inst.name}</div>))}</div>
                    {["11:00", "12:00", "13:00", "14:00", "15:00", "16:00"].map(hour => (
                        <div key={hour} className="flex border-b border-gray-100/30 h-28 relative"><div className="w-20 flex-shrink-0 p-2 border-r border-gray-100/50 bg-gray-50/80 flex items-center justify-center text-sm font-bold text-gray-500 sticky left-0 z-10 shadow-sm backdrop-blur-md">{hour}</div>
                            {coaches.map(inst => {
                                const group = dailyGroups.find(g => g.instructor === inst.name && g.schedule && g.schedule.some(s => s.time === hour && s.day === getDayNameFromDate(new Date())));
                                if (group) { const taken = group.records && group.records[new Date().toISOString().split('T')[0]] ? Object.keys(group.records[new Date().toISOString().split('T')[0]]).length > 0 : false;
                                return <div key={`${inst.id}-${hour}`} className="flex-1 border-r border-gray-100/30 p-1 relative min-w-[120px]"><div onClick={() => onGroupClick(group)} className={`w-full h-full border rounded-2xl p-3 cursor-pointer transition-all flex flex-col justify-center gap-2 shadow-sm overflow-hidden backdrop-blur-sm group ${taken ? "bg-emerald-500/10 border-emerald-500/30" : "bg-blue-500/5 border-blue-500/20"}`}><div className="font-bold text-sm text-gray-800 truncate">{group.name}</div><div className="text-[11px] text-gray-600 font-medium flex items-center gap-1"><Icon name="Users" size={12} className="text-gray-400" /> {(group.players||[]).length} Oyuncu</div></div></div>; } else return <div key={`${inst.id}-${hour}`} className="flex-1 border-r border-gray-100/30 p-1 min-w-[120px]"><div className="w-full h-full hover:bg-white/20 transition-colors rounded-2xl"></div></div>;
                            })}
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- ANA APP (ORİJİNAL) ---
        const App = () => {
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [userRole, setUserRole] = useState(() => { const saved = localStorage.getItem('dtk_session_v1'); return saved ? JSON.parse(saved).role : null; });
            const [currentCoach, setCurrentCoach] = useState(() => { const saved = localStorage.getItem('dtk_session_v1'); return saved ? JSON.parse(saved).name : null; });
            const [appLogo, setAppLogo] = useState("https://cdn-icons-png.flaticon.com/512/33/33736.png");
            const [adminPassword, setAdminPassword] = useState("2121");
            const [selectedDate, setSelectedDate] = useState(() => { const today = new Date(); const offset = today.getTimezoneOffset(); const localDate = new Date(today.getTime() - (offset * 60 * 1000)); return localDate.toISOString().split('T')[0]; });
            const [groups, setGroups] = useState([]);
            const [definedCoaches, setDefinedCoaches] = useState([]);
            const [registeredStudents, setRegisteredStudents] = useState([]);
            const [activeGroup, setActiveGroup] = useState(null);
            
            const [loginModalType, setLoginModalType] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false); const [isStudentModalOpen, setIsStudentModalOpen] = useState(false); const [isCoachModalOpen, setIsCoachModalOpen] = useState(false); const [isSettingsOpen, setIsSettingsOpen] = useState(false); const [isAddExistingStudentModalOpen, setIsAddExistingStudentModalOpen] = useState(false); const [viewingProfileStudent, setViewingProfileStudent] = useState(null);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: '', onConfirm: null });
            
            const [adminTab, setAdminTab] = useState('schedule'); const [coachTab, setCoachTab] = useState('schedule');
            
            const [newGroupName, setNewGroupName] = useState(""); const [newCoachName, setNewCoachName] = useState(""); const [tempSchedule, setTempSchedule] = useState([]); const [tempDay, setTempDay] = useState("Cumartesi"); const [tempTime, setTempTime] = useState("11:00");
            const [newStudentName, setNewStudentName] = useState(""); const [newStudentAge, setNewStudentAge] = useState(""); const [newStudentPhone, setNewStudentPhone] = useState(""); const [newStudentPhoto, setNewStudentPhoto] = useState(null);
            const [selectedGroupIdForStudent, setSelectedGroupIdForStudent] = useState(""); const [targetGroupForAdd, setTargetGroupForAdd] = useState(null); const [selectedMemberIds, setSelectedMemberIds] = useState([]);
            const [newInstName, setNewInstName] = useState(""); const [newInstEmail, setNewInstEmail] = useState("");
            const [changePassData, setChangePassData] = useState({ current: '', new: '' }); const [loginStep, setLoginStep] = useState('email'); const [loginEmail, setLoginEmail] = useState(""); const [loginPass, setLoginPass] = useState(""); const [loginError, setLoginError] = useState(""); const [foundInst, setFoundInst] = useState(null);
            const [editingGroup, setEditingGroup] = useState(null); const [editingStudent, setEditingStudent] = useState(null);

            const photoInputRef = useRef(null);

            // Firebase Hazır Kontrolü (BEYAZ EKRAN ÇÖZÜMÜ)
            useEffect(() => { const c = setInterval(() => { if (window.firebaseUtils && window.firebaseDb) { setIsFirebaseReady(true); clearInterval(c); } }, 100); return () => clearInterval(c); }, []);

            // Veri Çekme (GÜVENLİ MOD)
            useEffect(() => {
                if(!isFirebaseReady) return;
                try {
                    window.firebaseUtils.onSnapshot(window.firebaseUtils.collection(window.firebaseDb, 'groups'), (s) => setGroups(s.docs.map(d=>({...d.data(), id:d.id, players:d.data().players||[], records:d.data().records||{}, schedule:d.data().schedule||[]}))));
                    window.firebaseUtils.onSnapshot(window.firebaseUtils.collection(window.firebaseDb, 'coaches'), (s) => setDefinedCoaches(s.docs.map(d=>({...d.data(), id:d.id}))));
                    window.firebaseUtils.onSnapshot(window.firebaseUtils.collection(window.firebaseDb, 'students'), (s) => setRegisteredStudents(s.docs.map(d=>({...d.data(), id:d.id}))));
                    window.firebaseUtils.onSnapshot(window.firebaseUtils.doc(window.firebaseDb, 'settings', 'app'), (d) => { if(d.exists()) { const dt=d.data(); if(dt.logo) setAppLogo(dt.logo); if(dt.adminPassword) setAdminPassword(dt.adminPassword); } });
                } catch(e) { console.error(e); }
            }, [isFirebaseReady]);

            if (!isFirebaseReady) return <div className="min-h-screen flex items-center justify-center bg-emerald-900 text-white"><div className="w-12 h-12 border-4 border-lime-400 border-t-transparent rounded-full animate-spin"></div></div>;

            const askConfirmation = (message, action) => { setConfirmModal({ isOpen: true, message, onConfirm: action }); };
            const closeConfirmModal = () => { setConfirmModal({ isOpen: false, message: '', onConfirm: null }); };
            const executeConfirm = () => { if (confirmModal.onConfirm) confirmModal.onConfirm(); closeConfirmModal(); };

            const handleLogout = () => { setUserRole(null); setCurrentCoach(null); setActiveGroup(null); localStorage.removeItem('dtk_session_v1'); };
            const handleAdminLogin = (e) => { e.preventDefault(); if(loginPass===adminPassword) { setUserRole('admin'); setLoginModalType(null); localStorage.setItem('dtk_session_v1', JSON.stringify({role:'admin'})); } else setLoginError("Hatalı şifre!"); };
            const checkCoachEmail = (e) => { e.preventDefault(); const i = definedCoaches.find(c=>c.email===loginEmail); if(i) { setFoundInst(i); setLoginStep(i.password?'password':'set-password'); setLoginError(""); } else setLoginError("Bulunamadı."); };
            const verifyCoachPass = (e) => { e.preventDefault(); if(foundInst.password===loginPass) { setUserRole('coach'); setCurrentCoach(foundInst.name); setLoginModalType(null); localStorage.setItem('dtk_session_v1', JSON.stringify({role:'coach', name:foundInst.name})); } else setLoginError("Şifre yanlış."); };
            const setCoachPass = async (e) => { e.preventDefault(); if(loginPass.length<4) return setLoginError("En az 4 karakter."); await window.firebaseUtils.updateDoc(window.firebaseUtils.doc(window.firebaseDb,'coaches',foundInst.id.toString()), {password:loginPass}); setUserRole('coach'); setCurrentCoach(foundInst.name); setLoginModalType(null); localStorage.setItem('dtk_session_v1', JSON.stringify({role:'coach', name:foundInst.name})); };

            const handlePhotoChange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = () => setNewStudentPhoto(reader.result); reader.readAsDataURL(file); } };
            
            const handleSaveGroup = async (e) => { e.preventDefault(); if(tempSchedule.length===0) return alert("Saat ekleyin."); if (editingGroup) { const r = window.firebaseUtils.doc(window.firebaseDb, 'groups', editingGroup.id.toString()); await window.firebaseUtils.updateDoc(r, { name: newGroupName, instructor: newCoachName, schedule: tempSchedule }); } else { const n={id:Date.now(), name:newGroupName, instructor:newCoachName, schedule:tempSchedule, players:[], records:{}}; await window.firebaseUtils.setDoc(window.firebaseUtils.doc(window.firebaseDb,'groups',n.id.toString()), n); } setIsModalOpen(false); setEditingGroup(null); setNewGroupName(""); setTempSchedule([]); };
            const handleAddCoach = async (e) => { e.preventDefault(); const n={id:Date.now(), name:newInstName, email:newInstEmail, password:null}; await window.firebaseUtils.setDoc(window.firebaseUtils.doc(window.firebaseDb,'coaches',n.id.toString()), n); setIsCoachModalOpen(false); setNewInstName(""); setNewInstEmail(""); };
            const handleAddStudentGlobal = async (e) => { e.preventDefault(); if(newStudentName.trim()) { if (editingStudent) { const r = window.firebaseUtils.doc(window.firebaseDb, 'students', editingStudent.id.toString()); const u = { name: newStudentName.trim(), age: newStudentAge, phone: newStudentPhone }; if (newStudentPhoto) u.photo = newStudentPhoto; await window.firebaseUtils.updateDoc(r, u); } else { const id=Date.now(); const n={id, name:newStudentName.trim(), age:newStudentAge, phone:newStudentPhone, photo:newStudentPhoto}; if(selectedGroupIdForStudent) { const g=groups.find(x=>x.id.toString()===selectedGroupIdForStudent); if(g) await window.firebaseUtils.updateDoc(window.firebaseUtils.doc(window.firebaseDb,'groups',g.id.toString()), {players:[...(g.players||[]), n]}); } await window.firebaseUtils.setDoc(window.firebaseUtils.doc(window.firebaseDb,'students',id.toString()), n); } } setIsStudentModalOpen(false); setEditingStudent(null); setNewStudentName(""); setNewStudentAge(""); setNewStudentPhone(""); setNewStudentPhoto(null); };
            const handleAddPlayerFromDetail = (e) => { e.preventDefault(); if(newStudentName.trim()) { const id=Date.now(); const n={id, name:newStudentName.trim(), age:newStudentAge, phone:newStudentPhone}; const gRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', activeGroup.id.toString()); window.firebaseUtils.updateDoc(gRef, { players: [...(activeGroup.players||[]), n] }); window.firebaseUtils.setDoc(window.firebaseUtils.doc(window.firebaseDb, 'students', id.toString()), n); setNewStudentName(""); setNewStudentAge(""); setNewStudentPhone(""); } };

            const openEditGroupModal = (g, e) => { e.stopPropagation(); setEditingGroup(g); setNewGroupName(g.name); setNewCoachName(g.instructor); setTempSchedule(g.schedule||[]); setIsModalOpen(true); };
            const openEditStudent = (s) => { setEditingStudent(s); setNewStudentName(s.name); setNewStudentAge(s.age||""); setNewStudentPhone(s.phone||""); setNewStudentPhoto(s.photo||null); setIsStudentModalOpen(true); };
            
            const handleDeleteGroup = (id, e) => { if(e) e.stopPropagation(); askConfirmation("Grubu silmek istiyor musunuz?", async () => await window.firebaseUtils.deleteDoc(window.firebaseUtils.doc(window.firebaseDb,'groups',id.toString()))); };
            const handleDeleteStudentFromRegistry = (id) => { askConfirmation("Öğrenciyi silmek istiyor musunuz?", async () => await window.firebaseUtils.deleteDoc(window.firebaseUtils.doc(window.firebaseDb,'students',id.toString()))); };
            const handleDeleteCoach = (id) => { askConfirmation("Hocayı silmek istiyor musunuz?", async () => await window.firebaseUtils.deleteDoc(window.firebaseUtils.doc(window.firebaseDb,'coaches',id.toString()))); };
            const handleRemovePlayerFromGroup = (gid, pid) => { askConfirmation("Gruptan çıkarmak istiyor musunuz?", async () => { const g=groups.find(x=>x.id===gid); if(g) await window.firebaseUtils.updateDoc(window.firebaseUtils.doc(window.firebaseDb,'groups',gid.toString()), {players:(g.players||[]).filter(p=>p.id!==pid)}); }); };

            const toggleAttendance = async (pid, status) => { if(!activeGroup) return; const recs=activeGroup.records[selectedDate]||{}; const nRecs={...activeGroup.records, [selectedDate]:{...recs, [pid]:recs[pid]===status?null:status}}; setActiveGroup({...activeGroup, records:nRecs}); await window.firebaseUtils.updateDoc(window.firebaseUtils.doc(window.firebaseDb,'groups',activeGroup.id.toString()), {records:nRecs}); };
            const handleAddExistingStudents = async () => { if(!targetGroupForAdd || selectedMemberIds.length===0) return; const nP=[...(targetGroupForAdd.players||[])]; selectedMemberIds.forEach(id=>{ const s=registeredStudents.find(x=>x.id===id); if(s && !nP.some(p=>p.id===id)) nP.push(s); }); await window.firebaseUtils.updateDoc(window.firebaseUtils.doc(window.firebaseDb,'groups',targetGroupForAdd.id.toString()), {players:nP}); setIsAddExistingStudentModalOpen(false); setSelectedMemberIds([]); };
            const addScheduleSlot = () => { if(!tempSchedule.some(s=>s.day===tempDay&&s.time===tempTime)) setTempSchedule([...tempSchedule, {day:tempDay, time:tempTime}]); };
            const removeScheduleSlot = (idx) => setTempSchedule(tempSchedule.filter((_, i) => i !== idx));

            const validHours = ["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];
            const currentDayName = getDayNameFromDate(selectedDate);
            let dailyGroups = groups.filter(g => g.schedule && g.schedule.some(s => s.day === currentDayName));
            if(userRole==='coach') dailyGroups = dailyGroups.filter(g => g.instructor === currentCoach);

            // EKRANLAR
            if (!userRole) return <><WelcomeScreen onAdminClick={()=>{setLoginModalType('admin'); setLoginError(""); setLoginPass("");}} onCoachClick={()=>{setLoginModalType('coach'); setLoginStep('email'); setLoginError(""); setLoginEmail("");}} logoUrl={appLogo}/><style>{styles}</style>
            {loginModalType && <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50"><div className="glass-modal rounded-[32px] shadow-2xl w-full max-w-sm p-8 relative"><button onClick={()=>setLoginModalType(null)} className="absolute top-4 right-4 text-gray-500 font-bold p-2">✕</button>
            {loginModalType==='admin' ? <form onSubmit={handleAdminLogin} className="text-center"><div className="bg-emerald-100/80 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="Lock" size={36} className="text-emerald-600"/></div><h2 className="text-2xl font-black mb-6">Yönetici Girişi</h2><input type="password" autoFocus className="w-full text-center text-3xl tracking-widest border-2 rounded-2xl p-4 mb-4 bg-white/70" placeholder="••••" value={loginPass} onChange={e=>setLoginPass(e.target.value)} /><button className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg">Giriş Yap</button>{loginError && <p className="text-red-500 mt-4 font-bold">{loginError}</p>}</form> : 
            <div className="text-center"><div className="bg-lime-100/80 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="UserSquare" size={36} className="text-lime-700"/></div><h2 className="text-2xl font-black mb-6">Antrenör Girişi</h2>
            {loginStep==='email' && <form onSubmit={checkCoachEmail}><input type="email" required className="w-full border-2 rounded-2xl p-4 mb-4 bg-white/70" placeholder="E-posta" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)} /><button className="w-full bg-lime-500 text-white py-4 rounded-2xl font-bold shadow-lg">Devam Et</button></form>}
            {loginStep==='password' && <form onSubmit={verifyCoachPass}><p className="mb-4 font-bold">{foundInst?.name}</p><input type="password" autoFocus className="w-full border-2 rounded-2xl p-4 mb-4 bg-white/70" placeholder="Şifre" value={loginPass} onChange={e=>setLoginPass(e.target.value)} /><button className="w-full bg-lime-500 text-white py-4 rounded-2xl font-bold shadow-lg">Giriş Yap</button></form>}
            {loginStep==='set-password' && <form onSubmit={setCoachPass}><p className="mb-4 text-sm bg-yellow-100 p-2 rounded-xl">İlk giriş. Şifre belirleyin.</p><input type="password" required className="w-full border-2 rounded-2xl p-4 mb-4 bg-white/70" placeholder="Yeni Şifre" value={loginPass} onChange={e=>setLoginPass(e.target.value)} /><button className="w-full bg-lime-500 text-white py-4 rounded-2xl font-bold shadow-lg">Kaydet ve Gir</button></form>}
            {loginError && <p className="text-red-500 mt-4 font-bold">{loginError}</p>}</div>}</div></div>}</>;

            if (activeGroup) {
                const relevantSlot = activeGroup.schedule && activeGroup.schedule.find(s => s.day === currentDayName);
                const recs = activeGroup.records[selectedDate] || {};
                const safePlayers = activeGroup.players || [];
                const presentCount = safePlayers.filter(p => recs[p.id] === 'present').length;
                const absentCount = safePlayers.filter(p => recs[p.id] === 'absent').length;
                const canTakeAttendance = userRole === 'admin' || (userRole === 'coach' && currentCoach === activeGroup.instructor);

                return <div className="min-h-screen bg-tennis-court flex flex-col"><style>{styles}</style>
                <Header title={activeGroup.name} showBack={true} onBack={()=>setActiveGroup(null)} userRole={userRole} onLogout={handleLogout} logoUrl={appLogo} onOpenSettings={()=>setIsSettingsOpen(true)}/>
                <div className="p-5 bg-emerald-50/80 backdrop-blur-md border-b border-emerald-100/50 shadow-sm"><div className="flex justify-between items-center"><div><div className="font-black text-xl text-emerald-900 flex items-center gap-2 tracking-tight"><Icon name="UserSquare" size={24} className="text-emerald-700" /> {activeGroup.instructor}</div><div className="text-sm text-emerald-700 font-medium mt-1 flex gap-3"><span>{relevantSlot?.day}</span> • <span>{relevantSlot?.time}</span></div></div><div className="text-right p-3 bg-white/50 rounded-2xl border border-white/50 shadow-sm"><div className="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">KATILIM</div><div className="flex gap-3 text-lg font-black"><span className="text-lime-600 flex items-center gap-1"><Icon name="CheckSquare" size={18}/> {presentCount}</span><span className="text-red-500 flex items-center gap-1"><Icon name="Square" size={18}/> {absentCount}</span></div></div></div></div>
                {userRole === 'admin' && (<div className="p-4 bg-white/40 backdrop-blur-sm border-b border-white/30"><form onSubmit={handleAddPlayerFromDetail} className="space-y-3"><div className="text-xs font-bold text-gray-500 uppercase tracking-wider">HIZLI ÜYE EKLE</div><div className="flex gap-2"><input type="text" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} placeholder="Ad Soyad..." className="flex-1 border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/70 font-medium" /><input type="number" value={newStudentAge} onChange={(e) => setNewStudentAge(e.target.value)} placeholder="Yaş" className="w-20 border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/70 font-medium" /><input type="tel" value={newStudentPhone} onChange={(e) => setNewStudentPhone(e.target.value)} placeholder="Tel" className="w-28 border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/70 font-medium" /><button type="submit" className="bg-emerald-600 text-white px-4 rounded-2xl hover:bg-emerald-700 font-bold shadow-md"><Icon name="Plus" size={24}/></button></div></form></div>)}
                <div className="p-4 flex-1 overflow-y-auto pb-20">{safePlayers.length===0?<p className="text-center bg-white/50 p-4 rounded-xl">Öğrenci yok.</p>:safePlayers.map(p=>(<div key={p.id} onClick={()=>setViewingProfileStudent(p)} className="glass-card p-4 rounded-3xl mb-3 flex items-center justify-between cursor-pointer"><div className="flex items-center gap-3">{p.photo?<img src={p.photo} className="w-12 h-12 rounded-full object-cover border-2 border-white"/>:<div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">?</div>}<div><div className="font-bold text-lg">{p.name}</div><div className="text-xs text-gray-500">{p.age} Yaş</div></div></div><div className="flex gap-2" onClick={e=>e.stopPropagation()}>{canTakeAttendance && (<><button onClick={()=>toggleAttendance(p.id,'present')} className={`p-3 rounded-2xl border ${recs[p.id]==='present'?'bg-lime-500 text-white':'bg-white/50'}`}><Icon name="UserCheck"/></button><button onClick={()=>toggleAttendance(p.id,'absent')} className={`p-3 rounded-2xl border ${recs[p.id]==='absent'?'bg-red-500 text-white':'bg-white/50'}`}><Icon name="UserX"/></button></>)}{userRole==='admin' && (<><div className="w-px h-full bg-gray-200/50 mx-2"></div><button onClick={()=>handleRemovePlayerFromGroup(activeGroup.id, p.id)} className="p-3 rounded-2xl border bg-white/50 text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button></>)}</div></div>))}</div>
                {viewingProfileStudent && <StudentProfileModal student={viewingProfileStudent} groups={groups} onClose={()=>setViewingProfileStudent(null)}/>}</div>;
            }

            return <div className="min-h-screen bg-tennis-court flex flex-col relative"><style>{styles}</style><Header title="Diyarbakır Tenis" userRole={userRole} onLogout={handleLogout} logoUrl={appLogo} onLogoUpdate={async(u)=>{setAppLogo(u); await window.firebaseUtils.setDoc(window.firebaseUtils.doc(window.firebaseDb,'settings','app'),{logo:u},{merge:true})}} onOpenSettings={()=>setIsSettingsOpen(true)}/>
                <div className="flex-1 overflow-y-auto pb-32">
                {userRole === 'admin' ? (
                    <>
                        {adminTab === 'schedule' && <><HorizontalCalendar selectedDate={selectedDate} onSelectDate={setSelectedDate}/><div className="px-6 mt-6 mb-2"><h2 className="text-2xl font-black text-gray-800 flex items-center gap-2 tracking-tight"><span className="text-emerald-600">{currentDayName}</span> Programı</h2></div><AdminScheduleGrid dailyGroups={dailyGroups} coaches={definedCoaches} onGroupClick={setActiveGroup} /></>)}
                        {adminTab === 'groups' && <div className="p-4 space-y-3">{groups.map(g=><div key={g.id} className="glass-card p-4 rounded-3xl flex justify-between items-center"><div onClick={()=>setActiveGroup(g)} className="cursor-pointer flex-1"><div className="font-bold">{g.name}</div><div className="text-sm text-gray-500">{g.instructor}</div></div><div className="flex gap-2"><button onClick={(e)=>{openEditGroupModal(g,e)}} className="bg-blue-100 p-2 rounded-xl text-blue-600"><Icon name="Edit"/></button><button onClick={()=>{setTargetGroupForAdd(g); setIsAddExistingStudentModalOpen(true);}} className="bg-emerald-100 p-2 rounded-xl text-emerald-600"><Icon name="UserPlus"/></button><button onClick={(e)=>handleDeleteGroup(g.id, e)} className="bg-red-100 p-2 rounded-xl text-red-500"><Icon name="Trash2"/></button></div></div>)}</div>}
                        {adminTab === 'students' && <div className="p-4"><div className="relative mb-4"><Icon name="Users" size={20} className="absolute left-4 top-4 text-gray-400" /><input placeholder="Öğrenci Ara..." onChange={e=>{}} className="w-full border-2 border-gray-200/50 p-4 pl-12 rounded-3xl outline-none focus:border-emerald-500 bg-white/80 backdrop-blur-sm" /></div><div className="space-y-3">{registeredStudents.map(s=><div key={s.id} onClick={()=>setViewingProfileStudent(s)} className="glass-card p-4 rounded-3xl flex items-center gap-3 cursor-pointer">{s.photo ? <img src={s.photo} className="w-10 h-10 rounded-full object-cover"/> : <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold">?</div>}<div className="flex-1"><div className="font-bold">{s.name}</div><div className="text-xs text-gray-500">{s.phone}</div></div><div className="flex gap-2"><button onClick={(e)=>{e.stopPropagation(); openEditStudent(s);}} className="bg-blue-100 p-2 rounded-xl text-blue-600"><Icon name="Edit"/></button><button onClick={(e)=>{e.stopPropagation(); handleDeleteStudentFromRegistry(s.id)}} className="bg-red-100 p-2 rounded-xl text-red-500"><Icon name="Trash2"/></button></div></div>)}</div></div>}
                        {adminTab === 'coaches' && <div className="p-4 space-y-3">{definedCoaches.map(c=><div key={c.id} className="glass-card p-4 rounded-3xl flex justify-between items-center"><div><div className="font-bold">{c.name}</div><div className="text-xs text-gray-500">{c.email}</div></div><button onClick={()=>handleDeleteCoach(c.id)} className="bg-red-100 p-2 rounded-xl text-red-500"><Icon name="Trash2"/></button></div>)}</div>}
                        {adminTab === 'reports' && <AdminReportsView groups={groups} students={registeredStudents}/>}
                    </>
                ) : (
                    <><HorizontalCalendar selectedDate={selectedDate} onSelectDate={setSelectedDate}/><div className="px-6 mt-6 mb-2"><h2 className="text-2xl font-black text-gray-800 flex items-center gap-2 tracking-tight"><span className="text-emerald-600">{currentDayName}</span> Programı</h2></div><div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 pb-36">{dailyGroups.length===0?<div className="text-center glass-card p-10 rounded-3xl text-gray-500">Ders yok.</div>:dailyGroups.map(g=><div key={g.id} onClick={()=>setActiveGroup(g)} className="glass-card p-6 rounded-3xl relative cursor-pointer hover:scale-[1.02] transition-transform"><div className="absolute top-0 right-0 bg-emerald-100 text-emerald-800 px-4 py-2 rounded-bl-2xl rounded-tr-3xl font-bold text-sm">{g.schedule.find(s=>s.day===currentDayName)?.time}</div><h3 className="text-xl font-black mb-1 mt-2">{g.name}</h3><div className="border-t pt-3 flex justify-between text-sm font-bold text-emerald-700"><span>{(g.players||[]).length} Oyuncu</span><span>Yoklama <Icon name="ChevronRight" size={14}/></span></div></div>)}</div></>
                )}
                </div>

                {userRole==='admin' && (
                    <>
                    <div className="floating-nav p-2 fixed bottom-4 left-4 right-4 flex justify-between shadow-2xl z-20 pb-safe backdrop-blur-lg border border-white/40 rounded-[32px]">
                        <button onClick={()=>setAdminTab('schedule')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${adminTab==='schedule'?'text-emerald-700 bg-emerald-100/50 font-bold':'text-gray-400'}`}><Icon name="Calendar"/><span className="text-[9px] font-bold">Program</span></button>
                        <button onClick={()=>setAdminTab('groups')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${adminTab==='groups'?'text-emerald-700 bg-emerald-100/50 font-bold':'text-gray-400'}`}><Icon name="Layers"/><span className="text-[9px] font-bold">Gruplar</span></button>
                        <button onClick={()=>setAdminTab('students')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${adminTab==='students'?'text-emerald-700 bg-emerald-100/50 font-bold':'text-gray-400'}`}><Icon name="Users"/><span className="text-[9px] font-bold">Öğrenci</span></button>
                        <button onClick={()=>setAdminTab('coaches')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${adminTab==='coaches'?'text-emerald-700 bg-emerald-100/50 font-bold':'text-gray-400'}`}><Icon name="UserSquare"/><span className="text-[9px] font-bold">Hoca</span></button>
                        <button onClick={()=>setAdminTab('reports')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 ${adminTab==='reports'?'text-emerald-700 bg-emerald-100/50 font-bold':'text-gray-400'}`}><Icon name="ChartPie"/><span className="text-[9px] font-bold">Rapor</span></button>
                    </div>
                    {adminTab==='groups' && <button onClick={()=>setIsModalOpen(true)} className="fixed bottom-28 right-6 bg-lime-500 text-white p-5 rounded-full shadow-xl z-50 hover:scale-110 transition-transform"><Icon name="Plus" size={32}/></button>}
                    {adminTab==='students' && <button onClick={()=>setIsStudentModalOpen(true)} className="fixed bottom-28 right-6 bg-emerald-600 text-white p-5 rounded-full shadow-xl z-50 hover:scale-110 transition-transform"><Icon name="Plus" size={32}/></button>}
                    {adminTab==='coaches' && <button onClick={()=>setIsCoachModalOpen(true)} className="fixed bottom-28 right-6 bg-orange-500 text-white p-5 rounded-full shadow-xl z-50 hover:scale-110 transition-transform"><Icon name="UserPlus" size={32}/></button>}
                    </>
                )}
                {userRole === 'coach' && (
                    <div className="floating-nav p-2 fixed bottom-4 left-4 right-4 flex justify-around shadow-2xl z-20 pb-safe backdrop-blur-lg border border-white/40 rounded-[32px]">
                        <button onClick={() => setCoachTab('schedule')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${coachTab === 'schedule' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Calendar" size={26} /><span className="text-[10px] font-bold mt-1.5">Programım</span></button>
                        <button onClick={() => setCoachTab('students')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${coachTab === 'students' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Users" size={26} /><span className="text-[10px] font-bold mt-1.5">Öğrenciler</span></button>
                    </div>
                )}

                {/* MODALLER */}
                {isModalOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><div className="glass-modal p-8 rounded-[32px] w-full max-w-sm max-h-[90vh] overflow-y-auto border-t-white/50"><h3 className="font-black text-2xl mb-6">Grup Ekle</h3><form onSubmit={handleSaveGroup} className="space-y-4"><input required placeholder="Grup Adı" value={newGroupName} onChange={e=>setNewGroupName(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><select required value={newCoachName} onChange={e=>setNewCoachName(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"><option value="">Hoca Seç</option>{definedCoaches.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}</select><div className="flex gap-2"><select className="p-4 rounded-2xl border-2 flex-1" onChange={e=>setTempDay(e.target.value)} value={tempDay}><option>Cumartesi</option><option>Pazar</option></select><select className="p-4 rounded-2xl border-2" onChange={e=>setTempTime(e.target.value)} value={tempTime}>{validHours.map(h=><option key={h} value={h}>{h}</option>)}</select><button type="button" onClick={addScheduleSlot} className="bg-lime-500 text-white p-4 rounded-2xl"><Icon name="Plus"/></button></div><div className="space-y-2">{tempSchedule.map((s,i)=><div key={i} className="flex justify-between bg-white/50 p-2 rounded-xl text-sm font-bold border"><span>{s.day} - {s.time}</span><button type="button" onClick={()=>removeScheduleSlot(i)} className="text-red-500"><Icon name="Minus"/></button></div>)}</div><div className="flex gap-3 mt-6"><button type="button" onClick={()=>{setIsModalOpen(false); setEditingGroup(null);}} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold text-gray-500">İptal</button><button className="flex-1 bg-lime-500 text-white py-4 rounded-2xl font-bold shadow-lg">Kaydet</button></div></form></div></div>}
                {isStudentModalOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><div className="glass-modal p-8 rounded-[32px] w-full max-w-sm"><h3 className="font-black text-2xl mb-6">{editingStudent ? "Öğrenci Düzenle" : "Öğrenci Ekle"}</h3><form onSubmit={handleAddStudentGlobal} className="space-y-4"><div className="flex justify-center mb-4"><div className="w-24 h-24 rounded-full bg-gray-100 border-4 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative"><Icon name="Camera" className="text-gray-400"/><img src={newStudentPhoto} className="absolute inset-0 w-full h-full object-cover opacity-0" style={{opacity:newStudentPhoto?1:0}}/><input type="file" ref={photoInputRef} onChange={handlePhotoChange} className="absolute inset-0 opacity-0"/></div></div><input required placeholder="Ad Soyad" value={newStudentName} onChange={e=>setNewStudentName(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><input placeholder="Yaş" value={newStudentAge} onChange={e=>setNewStudentAge(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><input placeholder="Telefon" value={newStudentPhone} onChange={e=>setNewStudentPhone(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"/>{!editingStudent && <select className="w-full p-4 rounded-2xl border-2 border-gray-100" value={selectedGroupIdForStudent} onChange={e=>setSelectedGroupIdForStudent(e.target.value)}><option value="">Hedef Grup (Opsiyonel)</option>{groups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}</select>}<div className="flex gap-3 mt-6"><button type="button" onClick={()=>{setIsStudentModalOpen(false); setEditingStudent(null);}} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold text-gray-500">İptal</button><button className="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg">Kaydet</button></div></form></div></div>}
                {isCoachModalOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><div className="glass-modal p-8 rounded-[32px] w-full max-w-sm"><h3 className="font-black text-2xl mb-6">Hoca Ekle</h3><form onSubmit={handleAddCoach} className="space-y-4"><input required placeholder="Ad Soyad" value={newInstName} onChange={e=>setNewInstName(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><input type="email" required placeholder="E-posta" value={newInstEmail} onChange={e=>setNewInstEmail(e.target.value)} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><div className="flex gap-3 mt-6"><button type="button" onClick={()=>setIsCoachModalOpen(false)} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold text-gray-500">İptal</button><button className="flex-1 bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg">Kaydet</button></div></form></div></div>}
                {isAddExistingStudentModalOpen && targetGroupForAdd && <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><div className="glass-modal p-8 rounded-[32px] w-full max-w-sm max-h-[80vh] flex flex-col"><h3 className="font-black text-xl mb-4">Gruba Öğrenci Ekle</h3><p className="mb-4 font-bold text-emerald-600">{targetGroupForAdd.name}</p><div className="flex-1 overflow-y-auto border-2 rounded-2xl p-2 mb-4">{registeredStudents.filter(s=>!targetGroupForAdd.players.some(p=>p.id===s.id)).map(s=><div key={s.id} onClick={()=>{if(selectedMemberIds.includes(s.id)) setSelectedMemberIds(selectedMemberIds.filter(id=>id!==s.id)); else setSelectedMemberIds([...selectedMemberIds,s.id]);}} className={`p-3 mb-2 rounded-xl flex items-center gap-3 cursor-pointer border-2 ${selectedMemberIds.includes(s.id)?'border-emerald-500 bg-emerald-50':'border-transparent'}`}><div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${selectedMemberIds.includes(s.id)?'bg-emerald-500 border-emerald-500 text-white':'border-gray-300'}`}>{selectedMemberIds.includes(s.id) && <Icon name="Plus" size={14}/>}</div><div className="font-bold">{s.name}</div></div>)}</div><div className="flex gap-3"><button onClick={()=>{setIsAddExistingStudentModalOpen(false); setSelectedMemberIds([]);}} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold">İptal</button><button onClick={handleAddExistingStudents} className="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-bold">Ekle ({selectedMemberIds.length})</button></div></div></div>}
                
                {viewingProfileStudent && <StudentProfileModal student={viewingProfileStudent} groups={groups} onClose={()=>setViewingProfileStudent(null)}/>}
                {isSettingsOpen && <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><div className="glass-modal p-8 rounded-[32px] w-full max-w-sm"><h3 className="font-black text-2xl mb-6">Ayarlar</h3><form onSubmit={async(e)=>{e.preventDefault(); if(changePassData.current!==adminPassword) return alert("Hatalı şifre"); await window.firebaseUtils.setDoc(window.firebaseUtils.doc(window.firebaseDb,'settings','app'),{adminPassword:changePassData.new},{merge:true}); setIsSettingsOpen(false); alert("Şifre değişti");}} className="space-y-4"><input type="password" placeholder="Mevcut Şifre" value={changePassData.current} onChange={e=>setChangePassData({...changePassData, current:e.target.value})} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><input type="password" placeholder="Yeni Şifre" value={changePassData.new} onChange={e=>setChangePassData({...changePassData, new:e.target.value})} className="w-full p-4 rounded-2xl border-2 border-gray-100"/><button className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg">Şifreyi Güncelle</button><button type="button" onClick={()=>setIsSettingsOpen(false)} className="w-full bg-gray-100 py-4 rounded-2xl font-bold text-gray-500 mt-2">Kapat</button></form></div></div>}
                <ConfirmationDialog isOpen={confirmModal.isOpen} message={confirmModal.message} onConfirm={executeConfirm} onCancel={closeConfirmModal} />
            </div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
