<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diyarbakır Tenis Kulübü</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#065f46">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-tennis-court min-h-screen"> 
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // SENİN VERİTABANI BİLGİLERİN
        const firebaseConfig = {
            apiKey: "AIzaSyCsOde5aNv6HnNJMXtPLlGisXF_zXp3E5o",
            authDomain: "diyarbakirtenis-254b1.firebaseapp.com",
            databaseURL: "https://diyarbakirtenis-254b1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "diyarbakirtenis-254b1",
            storageBucket: "diyarbakirtenis-254b1.firebasestorage.app",
            messagingSenderId: "664290250808",
            appId: "1:664290250808:web:bd0ff27083ea50f145d6cd",
            measurementId: "G-LL1R6KD89Q"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase Tam Sürüm Bağlantısı Başarılı.");
        } catch (error) {
            console.error("Firebase Hatası:", error);
        }

        // Global Değişkenler
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        
        window.firebaseUtils = {
            collection,
            doc,
            getDoc,
            onSnapshot,
            updateDoc,
            setDoc,
            deleteDoc,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        };

        // React'e haber ver
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Righteous&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .font-sport { font-family: 'Righteous', cursive; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .logo-container { width: 40px; height: 40px; overflow: hidden; border-radius: 50%; border: 2px solid #bef264; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .student-photo-sm { width: 36px; height: 36px; overflow: hidden; border-radius: 50%; border: 2px solid #fff; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logo-img { width: 100%; height: 100%; object-fit: cover; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        
        .bg-tennis-court { background-color: #f0fdf4; }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        .glass-modal { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .welcome-bg { background-image: linear-gradient(to bottom, rgba(6, 95, 70, 0.8), rgba(6, 78, 59, 0.9)), url('https://images.unsplash.com/photo-1622163642998-1ea36b1ad565?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; }
        .floating-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-radius: 24px 24px 0 0; margin: 0 10px; }
    </style>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- İKONLAR ---
        const icons = {
            ChartPie: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Key: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
            Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            UserCheck: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>,
            UserX: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Minus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            UserSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="12" cy="10" r="3"/><path d="M7 21v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Layers: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Phone: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Info: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            UserPlus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
            Mail: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            CheckSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Square: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Star: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        };

        const Icon = ({ name, size = 20, className }) => {
            const IconComponent = icons[name];
            return IconComponent ? <IconComponent width={size} height={size} className={className} /> : null;
        };

        const getDayNameFromDate = (dateStr) => {
            const date = new Date(dateStr);
            const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            return days[date.getDay()];
        };
        const getStatusColor = (status) => status === 'present' ? 'bg-lime-500' : status === 'absent' ? 'bg-red-500' : 'bg-gray-200';
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();

        // --- Header Bileşeni ---
        const Header = ({ title, showBack = false, onBack, userRole, currentCoach, onShowLogin, onLogout, logoUrl, onLogoUpdate, onOpenSettings }) => {
            const fileInputRef = useRef(null);

            const handleLogoClick = () => {
                if(userRole === 'admin' && fileInputRef.current) fileInputRef.current.click();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => onLogoUpdate(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="bg-emerald-900/90 backdrop-blur-md p-4 text-white shadow-lg flex justify-between items-center sticky top-0 z-30 border-b border-white/10">
                    <div className="flex items-center gap-3">
                        {showBack ? (
                            <button onClick={onBack} className="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-colors"><Icon name="ChevronLeft" size={24} /></button>
                        ) : (
                            <div onClick={handleLogoClick} className={`logo-container bg-white flex items-center justify-center shadow-lg ${userRole === 'admin' ? 'cursor-pointer hover:opacity-80' : ''}`}>
                                <img src={logoUrl || "https://cdn-icons-png.flaticon.com/512/33/33736.png"} alt="Logo" className="logo-img" />
                                {userRole === 'admin' && <div className="absolute inset-0 bg-black/30 flex items-center justify-center text-white opacity-0 hover:opacity-100"><Icon name="Camera" size={16} /></div>}
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                            </div>
                        )}
                        <div>
                            <h1 className="text-lg font-bold leading-tight tracking-tight font-sport">{title}</h1>
                            {!showBack && <p className="text-[10px] text-emerald-200 uppercase tracking-wider font-medium">{userRole === 'admin' ? 'YÖNETİCİ MODU' : userRole === 'coach' ? `ANTRENÖR: ${currentCoach ? currentCoach.toUpperCase() : ''}` : 'MİSAFİR MODU'}</p>}
                        </div>
                    </div>
                    <div className="flex gap-2">
                        {userRole === 'admin' && (
                             <button onClick={onOpenSettings} className="p-2 rounded-full bg-emerald-800/50 text-white border border-white/20 shadow hover:bg-emerald-700/50 backdrop-blur-sm" title="Ayarlar"><Icon name="Settings" size={20} /></button>
                        )}
                        {userRole === 'guest' ? (
                            <button onClick={onShowLogin} className="p-2 rounded-full bg-emerald-900 border-emerald-700 text-emerald-400 border-2"><Icon name="Lock" size={20} /></button>
                        ) : (
                            <button onClick={onLogout} className="p-2 rounded-full bg-red-500/80 text-white border border-red-400 shadow hover:bg-red-600/80 backdrop-blur-sm" title="Çıkış Yap"><Icon name="LogOut" size={20} /></button>
                        )}
                    </div>
                </div>
            );
        };

        const HorizontalCalendar = ({ selectedDate, onSelectDate }) => {
            const days = useMemo(() => {
                const result = [];
                const current = new Date(selectedDate);
                for (let i = -14; i <= 14; i++) {
                    const d = new Date(current);
                    d.setDate(current.getDate() + i);
                    if (d.getDay() === 0 || d.getDay() === 6) result.push(d);
                }
                return result.sort((a, b) => a - b);
            }, [selectedDate]);

            return (
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-4 px-4 bg-emerald-900/90 backdrop-blur-md text-white shadow-inner border-b border-white/10">
                    {days.map((date, idx) => {
                        const dateStr = date.toISOString().split('T')[0];
                        const isSelected = dateStr === selectedDate;
                        const dateObj = new Date(dateStr);
                        const dayName = new Intl.DateTimeFormat('tr-TR', { weekday: 'short' }).format(dateObj);
                        const dayNum = dateObj.getDate();
                        const monthName = new Intl.DateTimeFormat('tr-TR', { month: 'short' }).format(dateObj);
                        const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;

                        return (
                            <button key={idx} onClick={() => onSelectDate(dateStr)} className={`flex flex-col items-center justify-center min-w-[58px] p-2 rounded-2xl transition-all border ${isSelected ? 'bg-lime-400 text-emerald-900 font-bold shadow-lg scale-105 border-lime-300' : 'hover:bg-white/10 text-emerald-100 border-transparent'} ${isWeekend && !isSelected ? 'border-b-4 border-b-yellow-400/50' : ''}`}>
                                <span className="text-[10px] uppercase opacity-80 font-medium">{dayName}</span>
                                <span className="text-xl font-black tracking-tight">{dayNum}</span>
                                <span className="text-[9px] opacity-70 uppercase font-medium">{monthName}</span>
                            </button>
                        );
                    })}
                </div>
            );
        };

        const ConfirmationDialog = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-[60] animate-[fadeIn_0.1s_ease-out]">
                    <div className="glass-modal rounded-3xl shadow-2xl w-full max-w-xs overflow-hidden p-6 text-center">
                        <div className="bg-red-100/80 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 shadow-sm"><Icon name="AlertCircle" size={32}/></div>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">Emin misiniz?</h3>
                        <p className="text-sm text-gray-600 mb-6 leading-relaxed font-medium">{message}</p>
                        <div className="flex gap-3"><button onClick={onCancel} className="flex-1 py-3 bg-gray-100/80 text-gray-700 rounded-2xl font-bold hover:bg-gray-200/80 transition-colors">İptal</button><button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-2xl font-bold hover:bg-red-600 shadow-md transition-colors">Evet</button></div>
                    </div>
                </div>
            );
        };

        const WelcomeScreen = ({ onAdminClick, onCoachClick, logoUrl }) => {
            return (
                <div className="min-h-screen welcome-bg flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute inset-0 bg-black/30"></div>
                    <div className="glass-card p-8 rounded-[40px] w-full max-w-sm shadow-2xl animate-slide-up flex flex-col items-center z-10 border-t-white/50">
                        <div className="bg-white p-4 rounded-full shadow-xl mb-6 ring-4 ring-white/30"><img src={logoUrl || "https://cdn-icons-png.flaticon.com/512/33/33736.png"} alt="Logo" className="w-28 h-28 object-cover rounded-full" /></div>
                        <h1 className="text-4xl font-black text-white text-center mb-2 drop-shadow-lg tracking-tight font-sport">Diyarbakır</h1>
                        <h2 className="text-xl font-bold text-lime-300 text-center mb-10 tracking-[0.2em] drop-shadow font-sport">TENİS KULÜBÜ</h2>
                        <div className="w-full space-y-4">
                            <button onClick={onCoachClick} className="w-full bg-lime-500 hover:bg-lime-400 text-emerald-900 font-bold py-4 px-6 rounded-3xl transition-all transform hover:scale-[1.02] shadow-lg flex items-center justify-center gap-3 text-lg"><Icon name="UserSquare" size={24} /> GİRİŞ YAP</button>
                        </div>
                        <p className="mt-10 text-white/70 text-xs font-medium">© 2025 DTK App v5.2 Premium</p>
                    </div>
                </div>
            );
        };

        const StudentProfileModal = ({ student, groups, onClose }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const changeMonth = (offset) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + offset); setViewDate(d); };
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = new Date(year, month, 1).getDay();
            const startingSlot = firstDay === 0 ? 6 : firstDay - 1;
            
            const detailedRecords = useMemo(() => {
                const details = [];
                groups.forEach(g => {
                    if(g.players.some(pl => pl.id === student.id)) {
                        Object.entries(g.records).forEach(([ds, st]) => {
                            const s = st[student.id];
                            if(s) {
                                const rd = new Date(ds);
                                if(rd.getFullYear() === year && rd.getMonth() === month) {
                                    details.push({ date: ds, status: s, groupName: g.name });
                                }
                            }
                        });
                    }
                });
                return details.sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [groups, student, year, month]);

            const pCount = detailedRecords.filter(r => r.status === 'present').length;
            const aCount = detailedRecords.filter(r => r.status === 'absent').length;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                    <div className="glass-modal rounded-3xl w-full max-w-sm overflow-hidden max-h-[80vh] flex flex-col shadow-2xl">
                        <div className="bg-emerald-800/90 p-5 text-white flex justify-between flex-shrink-0 items-center backdrop-blur-md">
                            <div className="flex items-center gap-4">
                                {student.photo ? <img src={student.photo} className="w-14 h-14 rounded-full border-4 border-white/30 object-cover shadow-sm" /> : <div className="w-14 h-14 rounded-full bg-emerald-700 border-4 border-white/30 flex items-center justify-center font-bold text-xl">?</div>}
                                <div><h2 className="text-2xl font-bold tracking-tight">{student.name}</h2><p className="text-sm opacity-90 font-medium flex items-center gap-2"><Icon name="Phone" size={14}/> {student.phone} | {student.age} Yaş</p></div>
                            </div>
                            <button onClick={onClose} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors"><Icon name="Minus" size={20}/></button>
                        </div>
                        <div className="p-5 overflow-y-auto bg-white/60 backdrop-blur-md flex-1">
                            <div className="flex gap-3 mb-6 text-center"><div className="flex-1 bg-lime-500/10 p-3 rounded-2xl border border-lime-500/30 shadow-sm"><div className="text-3xl font-black text-lime-600">{pCount}</div><div className="text-[10px] font-bold text-lime-700 uppercase tracking-wider">BU AY KATILIM</div></div><div className="flex-1 bg-red-500/10 p-3 rounded-2xl border border-red-500/30 shadow-sm"><div className="text-3xl font-black text-red-600">{aCount}</div><div className="text-[10px] font-bold text-red-700 uppercase tracking-wider">BU AY YOK</div></div></div>
                            <div className="flex justify-between mb-4 items-center bg-white/40 p-2 rounded-xl"><button onClick={() => changeMonth(-1)} className="p-1"><Icon name="ChevronLeft"/></button><span className="font-bold text-lg text-gray-800">{new Intl.DateTimeFormat('tr-TR', { month: 'long', year: 'numeric' }).format(viewDate)}</span><button onClick={() => changeMonth(1)} className="p-1"><Icon name="ChevronRight"/></button></div>
                            <div className="grid grid-cols-7 gap-2 text-center text-xs mb-2 font-bold text-gray-500 uppercase tracking-widest"><span>Pt</span><span>Sa</span><span>Ça</span><span>Pe</span><span>Cu</span><span>Ct</span><span>Pa</span></div>
                            <div className="grid grid-cols-7 gap-2 mb-6 p-2 bg-white/40 rounded-2xl">
                                {Array.from({length: startingSlot}).map((_, i) => <div key={`e-${i}`} />)}
                                {Array.from({length: daysInMonth}).map((_, i) => {
                                    const d = i + 1; 
                                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const record = detailedRecords.find(r => r.date === dateStr);
                                    const status = record ? record.status : null;
                                    return <div key={d} className={`aspect-square flex items-center justify-center rounded-xl font-bold text-sm border-2 border-transparent relative overflow-hidden ${!status ? 'text-gray-400' : 'text-gray-800'}`}><span className="z-10">{d}</span>{status==='present'&&<div className="absolute inset-0 bg-lime-400 rounded-xl border-2 border-lime-500 opacity-80"></div>}{status==='absent'&&<div className="absolute inset-0 bg-red-400 rounded-xl border-2 border-red-500 opacity-80"></div>}</div>
                                })}
                            </div>
                            <div className="space-y-2 border-t border-gray-200/50 pt-4">
                                {detailedRecords.length === 0 ? <p className="text-sm text-center text-gray-500 font-medium py-4">Bu ay kayıt bulunamadı.</p> : detailedRecords.map((r, idx) => (
                                    <div key={idx} className="flex justify-between text-sm p-3 bg-white/70 rounded-xl shadow-sm border border-white/50 items-center">
                                        <span className="text-gray-600 font-medium flex items-center gap-2"><Icon name="Calendar" size={14} className="text-gray-400"/> {new Intl.DateTimeFormat('tr-TR', {day:'numeric', month:'long'}).format(new Date(r.date))}</span>
                                        <span className="text-gray-800 font-bold truncate max-w-[100px]">{r.groupName}</span>
                                        <span className={`font-black px-2 py-1 rounded-lg text-xs uppercase ${r.status === 'present' ? 'bg-lime-100 text-lime-700' : 'bg-red-100 text-red-700'}`}>{r.status === 'present' ? 'GELDİ' : 'GELMEDİ'}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminReportsView = ({ groups, students }) => {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const totalLessonsThisMonth = useMemo(() => {
                let count = 0;
                groups.forEach(g => {
                    Object.keys(g.records).forEach(dateStr => {
                        const d = new Date(dateStr);
                        if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) count++;
                    });
                });
                return count;
            }, [groups]);

            const topStudents = useMemo(() => {
                const list = [];
                students.forEach(s => {
                    let present = 0;
                    groups.forEach(g => {
                        if(g.players.some(p => p.id === s.id)) {
                            Object.values(g.records).forEach(rec => {
                                if(rec[s.id] === 'present') present++;
                            });
                        }
                    });
                    if(present > 0) list.push({ ...s, present });
                });
                return list.sort((a,b) => b.present - a.present).slice(0, 5);
            }, [students, groups]);

            const riskyStudents = useMemo(() => {
                const risks = [];
                students.forEach(s => {
                    let total = 0;
                    let absent = 0;
                    groups.forEach(g => {
                        if(g.players.some(p => p.id === s.id)) {
                            Object.values(g.records).forEach(rec => {
                                if(rec[s.id]) {
                                    total++;
                                    if(rec[s.id] === 'absent') absent++;
                                }
                            });
                        }
                    });
                    if(total > 2) { 
                        const ratio = absent / total;
                        if(ratio > 0.3) risks.push({ ...s, ratio: Math.round(ratio * 100), total, absent });
                    }
                });
                return risks.sort((a,b) => b.ratio - a.ratio);
            }, [students, groups]);

            return (
                <div className="p-4 space-y-6 pb-32">
                    <div className="glass-card p-6 rounded-3xl border-l-8 border-lime-400 flex items-center justify-between">
                        <div><div className="text-gray-500 font-bold text-xs uppercase tracking-wider">BU AY YAPILAN</div><div className="text-4xl font-black text-gray-800 mt-1">TOPLAM DERS</div></div>
                        <div className="text-5xl font-black text-lime-600">{totalLessonsThisMonth}</div>
                    </div>

                    <div className="glass-card p-6 rounded-3xl">
                        <h3 className="font-black text-gray-800 mb-4 flex items-center gap-2"><Icon name="Star" className="text-yellow-500"/> EN DEVAMLI ÖĞRENCİLER</h3>
                        <div className="space-y-3">
                            {topStudents.length === 0 ? <p className="text-center text-gray-400 text-sm">Henüz veri yok.</p> : topStudents.map((s, i) => (
                                <div key={i} className="flex items-center justify-between p-3 bg-white/60 rounded-xl border border-white/50">
                                    <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-yellow-100 text-yellow-700 flex items-center justify-center font-bold text-sm">{i+1}</div><span className="font-bold text-gray-700">{s.name}</span></div>
                                    <span className="font-black text-emerald-600 text-lg">{s.present} <span className="text-xs font-normal text-gray-400">Ders</span></span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="glass-card p-6 rounded-3xl border-l-8 border-red-400">
                        <h3 className="font-black text-gray-800 mb-4 flex items-center gap-2"><Icon name="AlertCircle" className="text-red-500"/> RİSKLİ ÖĞRENCİLER</h3>
                        <div className="space-y-3">
                            {riskyStudents.length === 0 ? <p className="text-center text-gray-400 text-sm py-2">Riskli öğrenci yok. Harika!</p> : riskyStudents.map((s, i) => (
                                <div key={i} className="flex items-center justify-between p-3 bg-red-50/50 rounded-xl border border-red-100">
                                    <div><div className="font-bold text-gray-800">{s.name}</div><div className="text-xs text-red-400 font-medium">{s.absent} devamsızlık / {s.total} ders</div></div>
                                    <div className="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-black text-sm">%{s.ratio}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ANA UYGULAMA BİLEŞENİ ---
        const App = () => {
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [userRole, setUserRole] = useState(null); // Admin veya Coach
            const [authUser, setAuthUser] = useState(null); // Firebase kullanıcısı
            const [currentCoach, setCurrentCoach] = useState(null);
            const [appLogo, setAppLogo] = useState("https://cdn-icons-png.flaticon.com/512/33/33736.png");
            const [loginModalType, setLoginModalType] = useState(null);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: '', onConfirm: null });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(() => { const today = new Date(); const offset = today.getTimezoneOffset(); const localDate = new Date(today.getTime() - (offset * 60 * 1000)); return localDate.toISOString().split('T')[0]; });
            const [groups, setGroups] = useState([]);
            const [definedCoaches, setDefinedCoaches] = useState([]);
            const [registeredStudents, setRegisteredStudents] = useState([]);
            const [activeGroup, setActiveGroup] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false); 
            const [isStudentModalOpen, setIsStudentModalOpen] = useState(false); 
            const [isAddExistingStudentModalOpen, setIsAddExistingStudentModalOpen] = useState(false);
            const [isCoachModalOpen, setIsCoachModalOpen] = useState(false); 
            const [adminTab, setAdminTab] = useState('schedule');
            const [coachTab, setCoachTab] = useState('schedule'); 
            const [viewingProfileStudent, setViewingProfileStudent] = useState(null);
            const [newGroupName, setNewGroupName] = useState("");
            const [newCoachName, setNewCoachName] = useState("");
            const [tempSchedule, setTempSchedule] = useState([]);
            const [tempDay, setTempDay] = useState("Cumartesi");
            const [tempTime, setTempTime] = useState("11:00");
            const [newStudentName, setNewStudentName] = useState("");
            const [newStudentAge, setNewStudentAge] = useState("");
            const [newStudentPhone, setNewStudentPhone] = useState("");
            const [newStudentPhoto, setNewStudentPhoto] = useState(null);
            const [selectedGroupIdForStudent, setSelectedGroupIdForStudent] = useState("");
            const [targetGroupForAdd, setTargetGroupForAdd] = useState(null);
            const [selectedMemberIds, setSelectedMemberIds] = useState([]);
            const [newInstName, setNewInstName] = useState("");
            const [newInstEmail, setNewInstEmail] = useState("");
            const [editingGroup, setEditingGroup] = useState(null);
            const [editingStudent, setEditingStudent] = useState(null);

            // Firebase Hazırlık Hook'u
            useEffect(() => {
                const handleReady = () => setIsFirebaseReady(true);
                if (window.firebaseUtils && window.firebaseDb) {
                    setIsFirebaseReady(true);
                }
                window.addEventListener('firebase-ready', handleReady);
                
                // Auth Listener (Oturum durumunu dinle ve ROLE KONTROLÜ YAP)
                if (window.firebaseUtils) {
                    const { onAuthStateChanged, getDoc, doc } = window.firebaseUtils;
                    const { firebaseAuth, firebaseDb } = window;
                    onAuthStateChanged(firebaseAuth, async (user) => {
                        setAuthUser(user);
                        if (user) {
                            // Firestore'dan rolü kontrol et
                            try {
                                const userRef = doc(firebaseDb, "users", user.email);
                                const userSnap = await getDoc(userRef);
                                
                                if (userSnap.exists() && userSnap.data().role === 'admin') {
                                    setUserRole('admin');
                                } else {
                                    setUserRole('coach');
                                    // ÖNEMLİ: Hocanın ismini e-postadan bul
                                    // Coaches verisini beklemeden önce basitçe set et, sonra güncellenir
                                    setCurrentCoach(user.email.split('@')[0]);
                                }
                            } catch (e) {
                                console.error("Rol okuma hatası:", e);
                                setUserRole('coach'); // Hata durumunda varsayılan coach
                            }
                        } else {
                            setUserRole(null);
                        }
                    });
                }

                return () => window.removeEventListener('firebase-ready', handleReady);
            }, []);

            // Veri Çekme Hook'u (Auth olduktan sonra çalışır)
            useEffect(() => {
                const unsubscribers = [];

                if(window.firebaseUtils && window.firebaseDb && authUser) { // Sadece giriş yapıldıysa
                    const groupsRef = window.firebaseUtils.collection(window.firebaseDb, 'groups');
                    const unsubGroups = window.firebaseUtils.onSnapshot(groupsRef, (snapshot) => {
                        const groupsData = [];
                        snapshot.forEach((doc) => {
                            const d = doc.data();
                            // Esnek veri eşleştirme
                            groupsData.push({ 
                                ...d, 
                                id: doc.id,
                                name: d.name || d.grupAdi || "İsimsiz",
                                instructor: d.instructor || d.antrenor || "Bilinmiyor",
                                players: d.players || d.ogrenciler || [],
                                records: d.records || {}
                            });
                        });
                        setGroups(groupsData);
                    });
                    unsubscribers.push(unsubGroups);

                    const coachesRef = window.firebaseUtils.collection(window.firebaseDb, 'coaches');
                    const unsubCoaches = window.firebaseUtils.onSnapshot(coachesRef, (snapshot) => {
                        const coachesData = [];
                        snapshot.forEach((doc) => {
                            const d = doc.data();
                            coachesData.push({ 
                                ...d, 
                                id: doc.id,
                                name: d.name || d.ad_soyad || "Hoca",
                                email: d.email || d.mail
                            });
                        });
                        setDefinedCoaches(coachesData);
                    });
                    unsubscribers.push(unsubCoaches);

                    const studentsRef = window.firebaseUtils.collection(window.firebaseDb, 'students');
                    const unsubStudents = window.firebaseUtils.onSnapshot(studentsRef, (snapshot) => {
                        const studentsData = [];
                        snapshot.forEach((doc) => {
                            const d = doc.data();
                            studentsData.push({ 
                                ...d, 
                                id: doc.id,
                                name: d.name || d.ad_soyad || "İsimsiz",
                                phone: d.phone || d.tel 
                            });
                        });
                        setRegisteredStudents(studentsData);
                    });
                    unsubscribers.push(unsubStudents);

                    const settingsRef = window.firebaseUtils.doc(window.firebaseDb, 'settings', 'app');
                    const unsubSettings = window.firebaseUtils.onSnapshot(settingsRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            if (data.logo) setAppLogo(data.logo);
                        }
                    });
                    unsubscribers.push(unsubSettings);
                }

                return () => {
                    unsubscribers.forEach(unsub => unsub());
                };
            }, [isFirebaseReady, authUser]);

            // HOCA İSMİNİ EŞLEŞTİRME (Yusuf hoca veriyi görsün diye)
            useEffect(() => {
                if (userRole === 'coach' && authUser && definedCoaches.length > 0) {
                    const matchedCoach = definedCoaches.find(c => c.email === authUser.email);
                    if (matchedCoach) {
                        setCurrentCoach(matchedCoach.name); // Veritabanındaki tam ismi al (Örn: "Yusuf Hoca")
                    }
                }
            }, [userRole, authUser, definedCoaches]);

            // Yardımcı Fonksiyonlar (Hooks dışı)
            const validHours = ["11:00", "12:00", "13:00", "14:00", "15:00", "16:00"];
            const askConfirmation = (message, action) => { setConfirmModal({ isOpen: true, message, onConfirm: action }); };
            const closeConfirmModal = () => { setConfirmModal({ isOpen: false, message: '', onConfirm: null }); };
            const executeConfirm = () => { if (confirmModal.onConfirm) confirmModal.onConfirm(); closeConfirmModal(); };
            
            // GÜVENLİ ÇIKIŞ
            const handleLogout = async () => { 
                const { signOut } = window.firebaseUtils;
                const { firebaseAuth } = window;
                await signOut(firebaseAuth);
                setUserRole(null); 
                setCurrentCoach(null); 
                setActiveGroup(null); 
            };

            const handleLogoUpdate = async (newLogo) => { const settingsRef = window.firebaseUtils.doc(window.firebaseDb, 'settings', 'app'); await window.firebase.setDoc(settingsRef, { logo: newLogo }, { merge: true }); };
            const addScheduleSlot = () => { const exists = tempSchedule.some(s => s.day === tempDay && s.time === tempTime); if(!exists) setTempSchedule([...tempSchedule, {day: tempDay, time: tempTime}]); };
            const removeScheduleSlot = (idx) => setTempSchedule(tempSchedule.filter((_, i) => i !== idx));
            const openEditGroupModal = (group, e) => { e.stopPropagation(); setEditingGroup(group); setNewGroupName(group.name); setNewCoachName(group.instructor); setTempSchedule(group.schedule || []); setIsModalOpen(true); };
            
            const handleSaveGroup = async (e) => { 
                e.preventDefault(); 
                if(tempSchedule.length === 0) { alert("Lütfen saat ekleyiniz."); return; } 
                if (editingGroup) { 
                    const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', editingGroup.id.toString()); 
                    await window.firebaseUtils.updateDoc(groupRef, { name: newGroupName, instructor: newCoachName, schedule: tempSchedule }); 
                } else { 
                    const newGroup = { id: Date.now(), name: newGroupName, instructor: newCoachName, schedule: tempSchedule, players: [], records: {} }; 
                    const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', newGroup.id.toString()); 
                    await window.firebase.setDoc(groupRef, newGroup); 
                } 
                setIsModalOpen(false); setEditingGroup(null); setNewGroupName(""); setNewCoachName(""); setTempSchedule([]); 
            };
            
            const handleAddCoach = async (e) => { e.preventDefault(); if (definedCoaches.some(i => i.email === newInstEmail)) { alert("Bu e-posta zaten kayıtlı."); return; } const newInst = { id: Date.now(), name: newInstName, email: newInstEmail }; const coachRef = window.firebaseUtils.doc(window.firebaseDb, 'coaches', newInst.id.toString()); await window.firebase.setDoc(coachRef, newInst); setIsCoachModalOpen(false); setNewInstName(""); setNewInstEmail(""); alert("Antrenör veritabanına eklendi (Giriş için Firebase Authentication kullanın)."); };
            const handleDeleteGroup = (id, e) => { if(e) e.stopPropagation(); askConfirmation("Bu grubu ve içindeki tüm ders programını silmek istediğinize emin misiniz?", async () => { const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', id.toString()); await window.firebase.deleteDoc(groupRef); }); };
            const addPlayerLogic = async (targetGroupId, studentName, studentId = null, studentAge = "", studentPhone = "", studentPhoto = null) => { const newId = studentId || Date.now(); const newPlayer = { id: newId, name: studentName, age: studentAge, phone: studentPhone, photo: studentPhoto }; const targetGroup = groups.find(g => g.id.toString() === targetGroupId.toString()); if (targetGroup && !targetGroup.players.some(p => p.name === studentName)) { const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', targetGroupId.toString()); await window.firebaseUtils.updateDoc(groupRef, { players: [...targetGroup.players, newPlayer] }); } if(!registeredStudents.some(rs => rs.id === newId)) { const studentRef = window.firebaseUtils.doc(window.firebaseDb, 'students', newId.toString()); await window.firebase.setDoc(studentRef, newPlayer); } };
            const handleRemovePlayerFromGroup = (groupId, playerId) => { askConfirmation("Bu öğrenciyi gruptan çıkarmak istediğinize emin misiniz?", async () => { const targetGroup = groups.find(g => g.id === groupId); if (targetGroup) { const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', groupId.toString()); await window.firebaseUtils.updateDoc(groupRef, { players: targetGroup.players.filter(p => p.id !== playerId) }); if(activeGroup && activeGroup.id === groupId) setActiveGroup({ ...targetGroup, players: targetGroup.players.filter(p => p.id !== playerId) }); } }); };
            const photoInputRef = useRef(null);
            const handlePhotoChange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = () => setNewStudentPhoto(reader.result); reader.readAsDataURL(file); } };
            const handleAddPlayerFromDetail = (e) => { e.preventDefault(); if(newStudentName.trim()) addPlayerLogic(activeGroup.id, newStudentName.trim(), null, newStudentAge, newStudentPhone, null); setNewStudentName(""); setNewStudentAge(""); setNewStudentPhone(""); };
            
            const handleAddStudentGlobal = async (e) => { 
                e.preventDefault(); 
                if(newStudentName.trim()) { 
                    if (editingStudent) {
                        const studentRef = window.firebaseUtils.doc(window.firebaseDb, 'students', editingStudent.id.toString());
                        const updateData = { name: newStudentName.trim(), age: newStudentAge, phone: newStudentPhone };
                        if (newStudentPhoto) updateData.photo = newStudentPhoto;
                        await window.firebaseUtils.updateDoc(studentRef, updateData);
                    } else {
                        const newId = Date.now(); 
                        if (selectedGroupIdForStudent) await addPlayerLogic(selectedGroupIdForStudent, newStudentName.trim(), newId, newStudentAge, newStudentPhone, newStudentPhoto); 
                        else { 
                            const newPlayer = { id: newId, name: newStudentName.trim(), age: newStudentAge, phone: newStudentPhone, photo: newStudentPhoto }; 
                            const studentRef = window.firebaseUtils.doc(window.firebaseDb, 'students', newId.toString()); 
                            await window.firebase.setDoc(studentRef, newPlayer); 
                        } 
                    }
                } 
                setIsStudentModalOpen(false); 
                setEditingStudent(null);
                setNewStudentName(""); setNewStudentAge(""); setNewStudentPhone(""); setSelectedGroupIdForStudent(""); setNewStudentPhoto(null); 
            };

            const openEditStudent = (student) => {
                setEditingStudent(student);
                setNewStudentName(student.name);
                setNewStudentAge(student.age || "");
                setNewStudentPhone(student.phone || "");
                setNewStudentPhoto(student.photo || null);
                setIsStudentModalOpen(true);
            };

            const handleToggleSelection = (id) => { if (selectedMemberIds.includes(id)) setSelectedMemberIds(selectedMemberIds.filter(sid => sid !== id)); else setSelectedMemberIds([...selectedMemberIds, id]); };
            const handleAddMultipleExistingStudents = async (e) => { e.preventDefault(); if (!targetGroupForAdd || selectedMemberIds.length === 0) return; const newPlayers = [...targetGroupForAdd.players]; selectedMemberIds.forEach(sid => { const student = registeredStudents.find(s => s.id === sid); if(student && !newPlayers.some(p => p.id === sid)) newPlayers.push(student); }); const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', targetGroupForAdd.id.toString()); await window.firebaseUtils.updateDoc(groupRef, { players: newPlayers }); setIsAddExistingStudentModalOpen(false); setSelectedMemberIds([]); setTargetGroupForAdd(null); };
            const handleDeleteCoach = (id) => { const inst = definedCoaches.find(i => i.id === id); if (!inst) return; const assignedGroups = groups.filter(g => g.instructor === inst.name); const confirmMessage = assignedGroups.length > 0 ? `Bu antrenörün yönettiği ${assignedGroups.length} grup var. Silinirse gruplar antrenörsüz kalacak.` : `${inst.name} adlı antrenörü silmek istediğinize emin misiniz?`; askConfirmation(confirmMessage, async () => { const coachRef = window.firebaseUtils.doc(window.firebaseDb, 'coaches', id.toString()); await window.firebase.deleteDoc(coachRef); }); };
            
            const handleDeleteStudentFromRegistry = (studentId) => { askConfirmation("Bu öğrenciyi sistemden silerseniz, dahil olduğu tüm gruplardan da çıkarılacaktır.", async () => { const affectedGroups = groups.filter(g => g.players.some(p => p.id === studentId)); for (const group of affectedGroups) { const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', group.id.toString()); await window.firebaseUtils.updateDoc(groupRef, { players: group.players.filter(p => p.id !== studentId) }); } const studentRef = window.firebaseUtils.doc(window.firebaseDb, 'students', studentId.toString()); await window.firebase.deleteDoc(studentRef); }); };
            
            const getAttendanceInfo = (group, date) => { const recs = group.records[date]; if (!recs) return { taken: false, presentCount: 0 }; const taken = Object.keys(recs).length > 0; const presentCount = Object.values(recs).filter(s => s === 'present').length; return { taken, presentCount }; };
            const toggleAttendance = async (playerId, status) => { const targetGroup = groups.find(g => g.id === activeGroup.id); if (targetGroup) { const recs = targetGroup.records[selectedDate] || {}; const newStatus = recs[playerId] === status ? null : status; const updatedRecords = { ...targetGroup.records, [selectedDate]: { ...recs, [playerId]: newStatus } }; const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', activeGroup.id.toString()); await window.firebaseUtils.updateDoc(groupRef, { records: updatedRecords }); if(activeGroup) setActiveGroup({ ...targetGroup, records: updatedRecords }); } };

            const LoginPopup = () => {
                const [email, setEmail] = useState(""); 
                const [password, setPassword] = useState(""); 
                const [error, setError] = useState(""); 
                
                useEffect(() => { 
                    if(loginModalType) { setEmail(""); setPassword(""); setError(""); } 
                }, [loginModalType]);
                
                // GÜVENLİ GİRİŞ İŞLEMİ
                const handleSecureLogin = async (e) => {
                    e.preventDefault();
                    setError("");
                    try {
                        const { signInWithEmailAndPassword } = window.firebaseUtils;
                        const { firebaseAuth } = window;
                        await signInWithEmailAndPassword(firebaseAuth, email, password);
                        setLoginModalType(null); // Başarılıysa modalı kapat
                    } catch (err) {
                        setError("Giriş Başarısız: Şifre yanlış veya kullanıcı yok.");
                    }
                };

                if (!loginModalType) return null;
                return (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50 animate-[fadeIn_0.2s_ease-out]">
                        <div className="glass-modal rounded-[32px] shadow-2xl w-full max-w-sm overflow-hidden p-8 relative border-t-white/50">
                            <button onClick={() => setLoginModalType(null)} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 font-bold p-2 bg-white/30 rounded-full transition-colors">✕</button>
                            <div className="text-center">
                                <div className="bg-lime-100/80 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm ring-4 ring-white/50">
                                    <Icon name="UserSquare" size={36} className="text-lime-700"/>
                                </div>
                                <h2 className="text-2xl font-black text-gray-800 mb-6 tracking-tight">Güvenli Giriş</h2>
                                <form onSubmit={handleSecureLogin} className="space-y-4">
                                    <input type="email" required autoFocus className="w-full border-2 border-gray-200/80 rounded-2xl p-4 outline-none focus:border-emerald-500 bg-white/70 font-medium text-gray-700 transition-all focus:bg-white" placeholder="E-posta Adresi" value={email} onChange={e => setEmail(e.target.value)} />
                                    <input type="password" required className="w-full border-2 border-gray-200/80 rounded-2xl p-4 outline-none focus:border-emerald-500 bg-white/70 font-medium text-gray-700 transition-all focus:bg-white" placeholder="Şifre" value={password} onChange={e => setPassword(e.target.value)} />
                                    {error && <p className="text-red-500 text-sm font-medium bg-red-50 p-2 rounded-lg">{error}</p>}
                                    <button className="w-full bg-lime-500 text-white py-4 rounded-2xl font-bold hover:opacity-90 transition-colors shadow-lg text-lg">Giriş Yap</button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const AdminScheduleGrid = ({ dailyGroups, coaches, onGroupClick }) => (
                <div className="p-4 pb-36 overflow-x-auto">
                    <div className="min-w-[800px] glass-card rounded-3xl overflow-hidden shadow-sm">
                        <div className="flex border-b border-gray-100/50 bg-gray-50/50 backdrop-blur-sm">
                            <div className="w-20 flex-shrink-0 p-3 border-r border-gray-100/50 text-gray-400 font-bold text-xs text-center sticky left-0 z-10 bg-gray-50/90 backdrop-blur-md">SAAT</div>
                            {coaches.map(inst => (<div key={inst.id} className="flex-1 p-3 border-r border-gray-100/50 text-emerald-800 font-bold text-xs text-center truncate tracking-wider uppercase">{inst.name}</div>))}
                        </div>
                        {validHours.map(hour => (
                            <div key={hour} className="flex border-b border-gray-100/30 h-28 relative">
                                <div className="w-20 flex-shrink-0 p-2 border-r border-gray-100/50 bg-gray-50/80 flex items-center justify-center text-sm font-bold text-gray-500 sticky left-0 z-10 shadow-sm backdrop-blur-md">{hour}</div>
                                {coaches.map(inst => {
                                    // Beyaz Ekran Koruması (g.schedule &&)
                                    const group = dailyGroups.find(g => g.instructor === inst.name && g.schedule && g.schedule.some(s => s.time === hour && s.day === getDayNameFromDate(selectedDate)));
                                    if (group) {
                                        const { taken, presentCount } = getAttendanceInfo(group, selectedDate);
                                        const bgClass = taken ? "bg-emerald-500/10 border-emerald-500/30 hover:bg-emerald-500/20" : "bg-blue-500/5 border-blue-500/20 hover:bg-blue-500/10";
                                        return (
                                            <div key={`${inst.id}-${hour}`} className="flex-1 border-r border-gray-100/30 p-1 relative min-w-[120px]">
                                                <div onClick={() => onGroupClick(group)} className={`w-full h-full border rounded-2xl p-3 cursor-pointer transition-all flex flex-col justify-center gap-2 shadow-sm overflow-hidden backdrop-blur-sm group ${bgClass}`}>
                                                    <div className="font-bold text-sm text-gray-800 truncate leading-tight group-hover:text-black transition-colors">{group.name}</div>
                                                    <div className="text-[11px] text-gray-600 font-medium flex items-center gap-1"><Icon name="Users" size={12} className="text-gray-400" /> {taken ? <span className="font-bold text-emerald-700">{presentCount}/{group.players.length} Katıldı</span> : <span>{group.players.length} Oyuncu</span>}</div>
                                                    {taken && <div className="absolute top-2 right-2 w-3 h-3 bg-emerald-500 rounded-full ring-2 ring-white/50 shadow-sm"></div>}
                                                </div>
                                            </div>
                                        );
                                    } else return <div key={`${inst.id}-${hour}`} className="flex-1 border-r border-gray-100/30 p-1 min-w-[120px]"><div className="w-full h-full hover:bg-white/20 transition-colors rounded-2xl"></div></div>;
                                })}
                            </div>
                        ))}
                    </div>
                </div>
            );

            const AdminGroupsView = () => (
                <div className="p-4 grid grid-cols-1 gap-4 pb-36">
                    {groups.map(group => (
                        <div key={group.id} className="glass-card rounded-2xl p-5 shadow-sm border border-white/50 flex items-center justify-between hover:shadow-md transition-all">
                            <div onClick={() => setActiveGroup(group)} className="flex-1 cursor-pointer">
                                <div className="flex items-center gap-2 mb-2"><h3 className="font-bold text-lg text-gray-800 tracking-tight">{group.name}</h3></div>
                                {/* Beyaz Ekran Koruması (group.schedule &&) */}
                                <div className="flex flex-wrap gap-2 mb-3">{group.schedule && group.schedule.map((s, idx) => (<span key={idx} className="bg-emerald-100/50 border border-emerald-200/50 text-xs px-3 py-1 rounded-full text-emerald-700 font-medium">{s.day.slice(0,3)} {s.time}</span>))}</div>
                                <p className="text-sm text-gray-600 font-medium flex items-center gap-2"><Icon name="UserSquare" size={16} className="text-gray-400"/> {group.instructor}</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={(e) => openEditGroupModal(group, e)} className="p-3 bg-blue-50/80 text-blue-500 rounded-xl hover:bg-blue-500 hover:text-white transition-colors shadow-sm border border-blue-100/50"><Icon name="Edit" size={18} /></button>
                                <button onClick={(e) => {e.stopPropagation(); setTargetGroupForAdd(group); setIsAddExistingStudentModalOpen(true);}} className="p-3 bg-emerald-50/80 text-emerald-500 rounded-xl hover:bg-emerald-500 hover:text-white transition-colors shadow-sm border border-emerald-100/50"><Icon name="UserPlus" size={18} /></button>
                                <button onClick={(e) => handleDeleteGroup(group.id, e)} className="p-3 bg-red-50/80 text-red-400 rounded-xl hover:bg-red-500 hover:text-white transition-colors shadow-sm border border-red-100/50"><Icon name="Trash2" size={18} /></button>
                            </div>
                        </div>
                    ))}
                </div>
            );

            const AdminCoachesView = () => (
                <div className="p-4 pb-36 space-y-4">
                    {definedCoaches.map(inst => (
                        <div key={inst.id} className="glass-card p-5 rounded-2xl shadow-sm border border-white/50 flex justify-between items-center hover:shadow-md transition-all">
                            <div className="flex items-center gap-4">
                                <div className="bg-gradient-to-br from-orange-100 to-orange-200 p-4 rounded-2xl text-orange-600 shadow-inner"><Icon name="UserSquare" size={24} /></div>
                                <div><div className="font-bold text-lg text-gray-800 tracking-tight">{inst.name}</div><div className="text-sm text-gray-500 font-medium flex items-center gap-2"><Icon name="Mail" size={14} className="text-gray-400"/> {inst.email}</div></div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => handleDeleteCoach(inst.id)} className="p-3 text-red-400 bg-red-50/80 rounded-xl hover:bg-red-500 hover:text-white transition-colors shadow-sm border border-red-100/50"><Icon name="Trash2" size={20} /></button>
                            </div>
                        </div>
                    ))}
                </div>
            );

            const StandardView = ({ dailyGroups }) => {
                const currentDayName = getDayNameFromDate(selectedDate);
                // Beyaz Ekran Koruması (g.schedule &&)
                let filtered = dailyGroups.filter(g => g.schedule && g.schedule.some(s => s.day === currentDayName));
                
                // --- KRİTİK DÜZELTME: İSİM EŞLEŞTİRME ---
                if (userRole === 'coach' && currentCoach) {
                    filtered = filtered.filter(g => g.instructor === currentCoach);
                }
                
                if (filtered.length === 0) return <div className="text-center py-20 text-gray-400/80 border-2 border-dashed border-gray-300/50 m-4 rounded-3xl font-medium glass-card">
                    {userRole === 'coach' ? `Bugün için ders programı bulunmuyor (${currentCoach})` : 'Bugün için ders programı bulunmuyor.'}
                </div>;

                return (
                    <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 pb-36">
                        {filtered.map(g => {
                            // Beyaz Ekran Koruması (g.schedule &&)
                            const time = (g.schedule && g.schedule.find(s => s.day === currentDayName)?.time) || "";
                            const { taken, presentCount } = getAttendanceInfo(g, selectedDate);
                            const borderClass = taken ? "border-emerald-500/50 shadow-emerald-100/50" : "border-white/50 shadow-sm";
                            return (
                                <div key={g.id} onClick={() => setActiveGroup(g)} className={`glass-card rounded-3xl p-6 shadow-sm border hover:shadow-xl cursor-pointer relative group transition-all ${borderClass}`}>
                                    {taken && <div className="absolute top-3 left-3 bg-emerald-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-sm tracking-wide">YOKLAMA ALINDI</div>}
                                    <div className="absolute top-0 right-0 bg-emerald-100/80 backdrop-blur-sm text-emerald-800 px-4 py-2 rounded-bl-2xl rounded-tr-3xl text-sm font-bold font-mono shadow-inner border-b border-l border-white/50">{time}</div>
                                    <h3 className="text-xl font-black mb-1 mt-4 text-gray-800 tracking-tight group-hover:text-black transition-colors">{g.name}</h3>
                                    <div className="text-sm text-gray-500 mb-5 font-medium flex items-center gap-2"><Icon name="Calendar" size={14} className="text-gray-400"/> {currentDayName}</div>
                                    {userRole !== 'coach' && <div className="text-sm font-bold text-emerald-700 mb-5 flex items-center gap-2 bg-emerald-50/50 p-2 rounded-xl inline-block border border-emerald-100/50"><Icon name="UserSquare" size={16}/> {g.instructor}</div>}
                                    <div className="flex justify-between border-t border-gray-100/50 pt-4 text-sm text-gray-600 font-medium">
                                        {taken ? <div className="text-emerald-700 font-bold flex items-center gap-2"><Icon name="CheckSquare" size={16}/> {presentCount}/{g.players.length} Katıldı</div> : <div className="flex items-center gap-2"><Icon name="Users" size={16} className="text-gray-400"/> {g.players.length} Oyuncu</div>}
                                        <span className="font-bold text-emerald-600 flex items-center gap-1 group-hover:gap-2 transition-all">Detay <Icon name="ChevronRight" size={16}/></span>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                );
            };

            const AdminStudentsView = ({ readOnly = false }) => {
                const [search, setSearch] = useState("");
                const filtered = registeredStudents.filter(s => (s.name || "").toLowerCase().includes(search.toLowerCase()));
                return (
                    <div className="p-4 pb-36">
                        <div className="relative mb-6"><Icon name="Users" size={20} className="absolute left-4 top-4 text-gray-400" /><input placeholder="Öğrenci Ara..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full border-2 border-gray-200/50 p-4 pl-12 rounded-3xl outline-none focus:border-emerald-500 bg-white/80 backdrop-blur-sm font-medium transition-all focus:bg-white shadow-sm" /></div>
                        <div className="glass-card rounded-3xl shadow-sm border border-white/50 overflow-hidden">
                            <div className="grid grid-cols-12 bg-gray-50/50 backdrop-blur-sm p-4 text-xs font-bold text-gray-500 border-b border-gray-100/50 uppercase tracking-wider"><div className="col-span-2">Foto</div><div className="col-span-4">Ad Soyad</div><div className="col-span-3">Tel</div><div className="col-span-3 text-center">İşlem</div></div>
                            {filtered.map(s => (
                                <div key={s.id} onClick={() => setViewingProfileStudent(s)} className="grid grid-cols-12 p-4 text-sm items-center border-b border-gray-100/30 hover:bg-white/60 cursor-pointer transition-colors">
                                    <div className="col-span-2">{s.photo ? <img src={s.photo} className="student-photo-sm ring-2 ring-white shadow-sm" /> : <div className="student-photo-sm bg-gray-200 flex items-center justify-center text-[10px] text-gray-500 font-bold ring-2 ring-white shadow-sm">?</div>}</div>
                                    <div className="col-span-4 font-bold text-gray-800 truncate">{s.name || "İsimsiz"}</div>
                                    <div className="col-span-3 text-xs text-gray-500 font-medium truncate">{s.phone}</div>
                                    <div className="col-span-3 flex justify-center gap-2">
                                        {!readOnly && (
                                            <>
                                                {/* YENİ: DÜZENLEME BUTONU */}
                                                <button onClick={(e) => { e.stopPropagation(); openEditStudent(s); }} className="p-2 bg-blue-50/80 text-blue-500 rounded-xl hover:bg-blue-500 hover:text-white transition-colors shadow-sm border border-blue-100/50"><Icon name="Edit" size={16} /></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteStudentFromRegistry(s.id); }} className="p-2 bg-red-50/80 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-colors shadow-sm border border-red-100/50"><Icon name="Trash2" size={16} /></button>
                                            </>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // "if (!isFirebaseReady)" kontrolünü hook'lardan SONRA, render işleminden ÖNCE yapıyoruz.
            if (!isFirebaseReady) {
                return (
                    <div className="min-h-screen bg-tennis-court flex items-center justify-center">
                        <div className="text-emerald-800 font-bold text-xl animate-pulse flex flex-col items-center gap-4">
                            <div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                            Yükleniyor...
                        </div>
                    </div>
                );
            }

            // Giriş Yapılmamışsa
            if (!userRole) return <><WelcomeScreen onAdminClick={() => setLoginModalType('admin')} onCoachClick={() => setLoginModalType('coach')} logoUrl={appLogo} /><LoginPopup /></>;

            const currentDayName = getDayNameFromDate(selectedDate);
            // Beyaz Ekran Koruması (g.schedule &&)
            const dailyGroups = groups.filter(g => g.schedule && g.schedule.some(s => s.day === currentDayName));

            // Grup Detay Ekranı
            if (activeGroup) {
                // Beyaz Ekran Koruması (activeGroup.schedule &&)
                const relevantSlot = activeGroup.schedule && activeGroup.schedule.find(s => s.day === currentDayName);
                const recs = activeGroup.records[selectedDate] || {};
                const presentCount = activeGroup.players.filter(p => recs[p.id] === 'present').length;
                const absentCount = activeGroup.players.filter(p => recs[p.id] === 'absent').length;
                const canTakeAttendance = userRole === 'admin' || (userRole === 'coach' && currentCoach === activeGroup.instructor);

                return (
                    <div className="min-h-screen bg-tennis-court flex flex-col">
                        <Header title={activeGroup.name} showBack={true} onBack={() => setActiveGroup(null)} userRole={userRole} currentCoach={currentCoach} onShowLogin={() => setShowLogin(true)} onLogout={handleLogout} logoUrl={appLogo} onOpenSettings={() => setIsSettingsOpen(true)} />
                        <div className="p-5 bg-emerald-50/80 backdrop-blur-md border-b border-emerald-100/50 shadow-sm"><div className="flex justify-between items-center"><div><div className="font-black text-xl text-emerald-900 flex items-center gap-2 tracking-tight"><Icon name="UserSquare" size={24} className="text-emerald-700" /> {activeGroup.instructor}</div><div className="text-sm text-emerald-700 font-medium mt-1 flex gap-3"><span>{relevantSlot?.day}</span> • <span>{relevantSlot?.time}</span></div></div><div className="text-right p-3 bg-white/50 rounded-2xl border border-white/50 shadow-sm"><div className="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">KATILIM DURUMU</div><div className="flex gap-3 text-lg font-black"><span className="text-lime-600 flex items-center gap-1"><Icon name="CheckSquare" size={18}/> {presentCount}</span><span className="text-red-500 flex items-center gap-1"><Icon name="Square" size={18}/> {absentCount}</span></div></div></div></div>
                        {userRole === 'admin' && (<div className="p-4 bg-white/40 backdrop-blur-sm border-b border-white/30"><form onSubmit={handleAddPlayerFromDetail} className="space-y-3"><div className="text-xs font-bold text-gray-500 uppercase tracking-wider">HIZLI ÜYE EKLE</div><div className="flex gap-2"><input type="text" value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} placeholder="Ad Soyad..." className="flex-1 border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/70 font-medium" /><input type="number" value={newStudentAge} onChange={(e) => setNewStudentAge(e.target.value)} placeholder="Yaş" className="w-20 border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/70 font-medium" /><input type="tel" value={newStudentPhone} onChange={(e) => setNewStudentPhone(e.target.value)} placeholder="Tel" className="w-28 border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/70 font-medium" /><button type="submit" className="bg-emerald-600 text-white px-4 rounded-2xl hover:bg-emerald-700 font-bold shadow-md"><Icon name="Plus" size={24}/></button></div></form></div>)}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-36">
                            {activeGroup.players.map(p => { 
                                const status = recs[p.id]; 
                                return (
                                    <div key={p.id} onClick={() => setViewingProfileStudent(p)} className="flex items-center justify-between glass-card border-white/50 rounded-3xl p-4 shadow-sm hover:shadow-md transition-all cursor-pointer">
                                        <div className="flex-1 flex items-center gap-4">
                                            {p.photo ? <img src={p.photo} className="w-12 h-12 rounded-full border-2 border-white shadow-sm object-cover" /> : <div className="w-12 h-12 rounded-full bg-gray-200 border-2 border-white shadow-sm flex items-center justify-center text-xs font-bold text-gray-500">?</div>}
                                            <div>
                                                <div className="flex items-center gap-3"><div className={`w-3 h-3 rounded-full ring-2 ring-white shadow-sm ${getStatusColor(status)}`}></div><span className="font-bold text-lg text-gray-800">{p.name}</span></div>
                                                {(p.age || p.phone) && <div className="text-xs text-gray-500 ml-6 flex gap-3 font-medium mt-1">{p.age && <span className="bg-gray-100 px-2 py-0.5 rounded-md">{p.age} Yaş</span>}{p.phone && <span className="bg-gray-100 px-2 py-0.5 rounded-md">{p.phone}</span>}</div>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2" onClick={e => e.stopPropagation()}>
                                            {canTakeAttendance && (<><button onClick={() => toggleAttendance(p.id, 'present')} className={`p-3 rounded-2xl border transition-all shadow-sm ${status === 'present' ? 'bg-lime-500 text-white border-lime-600 shadow-lime-200' : 'bg-gray-50/80 text-gray-400 border-gray-200/50 hover:bg-lime-100'}`}><Icon name="UserCheck" size={20}/></button><button onClick={() => toggleAttendance(p.id, 'absent')} className={`p-3 rounded-2xl border transition-all shadow-sm ${status === 'absent' ? 'bg-red-500 text-white border-red-600 shadow-red-200' : 'bg-gray-50/80 text-gray-400 border-gray-200/50 hover:bg-red-100'}`}><Icon name="UserX" size={20}/></button></>)}
                                            {userRole === 'admin' && (<><div className="w-px h-full bg-gray-200/50 mx-2"></div><button onClick={() => handleRemovePlayerFromGroup(activeGroup.id, p.id)} className="p-3 rounded-2xl border bg-white/50 text-gray-300 border-gray-200/50 hover:border-red-200 hover:text-red-500 hover:bg-red-50 transition-all shadow-sm"><Icon name="Trash2" size={20}/></button></>)}
                                        </div>
                                    </div>
                                ); 
                            })}
                        </div>
                    </div>
                );
            }

            // ANA EKRAN DÖNÜŞÜ (YÖNETİCİ & ANTRENÖR)
            return (
                <div className="min-h-screen bg-tennis-court flex flex-col relative">
                    <Header title="Diyarbakır Tenis Kulübü" onBack={() => {}} userRole={userRole} currentCoach={currentCoach} onShowLogin={() => setShowLogin(true)} onLogout={handleLogout} logoUrl={appLogo} onLogoUpdate={handleLogoUpdate} onOpenSettings={() => setIsSettingsOpen(true)} />
                    
                    <div className="flex-1 overflow-y-auto">
                        {userRole === 'admin' ? (
                            <>
                                {adminTab === 'schedule' && (<><HorizontalCalendar selectedDate={selectedDate} onSelectDate={setSelectedDate} /><div className="px-6 mt-6 mb-2"><h2 className="text-2xl font-black text-gray-800 flex items-center gap-2 tracking-tight"><span className="text-emerald-600">{currentDayName}</span> Programı</h2></div><AdminScheduleGrid dailyGroups={dailyGroups} coaches={definedCoaches} onGroupClick={setActiveGroup} /></>)}
                                {adminTab === 'groups' && <AdminGroupsView />}
                                {adminTab === 'students' && <AdminStudentsView />}
                                {adminTab === 'coaches' && <AdminCoachesView />}
                                {adminTab === 'reports' && <AdminReportsView groups={groups} students={registeredStudents} />}
                            </>
                        ) : (
                            <>
                                {coachTab === 'schedule' && (
                                    <><HorizontalCalendar selectedDate={selectedDate} onSelectDate={setSelectedDate} /><div className="px-6 mt-6 mb-2"><h2 className="text-2xl font-black text-gray-800 flex items-center gap-2 tracking-tight"><span className="text-emerald-600">{currentDayName}</span> Programı</h2></div><StandardView dailyGroups={dailyGroups} /></>
                                )}
                                {coachTab === 'students' && <AdminStudentsView readOnly={true} />}
                            </>
                        )}
                    </div>

                    {/* YÖNETİCİ ALT MENÜSÜ */}
                    {userRole === 'admin' && (
                        <>
                            <div className="fixed bottom-28 right-6 z-40 flex flex-col gap-4">
                                {adminTab === 'groups' && <button onClick={() => setIsModalOpen(true)} className="bg-gradient-to-br from-lime-400 to-lime-600 text-white p-5 rounded-full shadow-lg hover:scale-110 transition-transform border-4 border-white/30"><Icon name="Plus" size={32} /></button>}
                                {adminTab === 'students' && <button onClick={() => setIsStudentModalOpen(true)} className="bg-gradient-to-br from-emerald-500 to-emerald-700 text-white p-5 rounded-full shadow-lg hover:scale-110 transition-transform border-4 border-white/30"><Icon name="Plus" size={32} /></button>}
                                {adminTab === 'coaches' && <button onClick={() => setIsCoachModalOpen(true)} className="bg-gradient-to-br from-orange-400 to-orange-600 text-white p-5 rounded-full shadow-lg hover:scale-110 transition-transform border-4 border-white/30"><Icon name="UserPlus" size={28} /></button>}
                            </div>
                            <div className="floating-nav p-2 fixed bottom-4 left-4 right-4 flex justify-between shadow-2xl z-20 pb-safe backdrop-blur-lg border border-white/40 rounded-[32px]">
                                <button onClick={() => setAdminTab('schedule')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${adminTab === 'schedule' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Calendar" size={24} /><span className="text-[9px] font-bold mt-1.5">Program</span></button>
                                <button onClick={() => setAdminTab('groups')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${adminTab === 'groups' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Layers" size={24} /><span className="text-[9px] font-bold mt-1.5">Gruplar</span></button>
                                <button onClick={() => setAdminTab('students')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${adminTab === 'students' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Users" size={24} /><span className="text-[9px] font-bold mt-1.5">Öğrenci</span></button>
                                <button onClick={() => setAdminTab('coaches')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${adminTab === 'coaches' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="UserSquare" size={24} /><span className="text-[9px] font-bold mt-1.5">Hoca</span></button>
                                <button onClick={() => setAdminTab('reports')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${adminTab === 'reports' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="ChartPie" size={24} /><span className="text-[9px] font-bold mt-1.5">Rapor</span></button>
                            </div>
                        </>
                    )}

                    {/* ANTRENÖR ALT MENÜSÜ */}
                    {userRole === 'coach' && (
                        <div className="floating-nav p-2 fixed bottom-4 left-4 right-4 flex justify-around shadow-2xl z-20 pb-safe backdrop-blur-lg border border-white/40 rounded-[32px]">
                             <button onClick={() => setCoachTab('schedule')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${coachTab === 'schedule' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Calendar" size={26} /><span className="text-[10px] font-bold mt-1.5">Programım</span></button>
                             <button onClick={() => setCoachTab('students')} className={`flex flex-col items-center p-3 rounded-2xl flex-1 transition-all ${coachTab === 'students' ? 'text-emerald-700 bg-emerald-100/50 shadow-inner font-bold' : 'text-gray-400 hover:bg-gray-50/50'}`}><Icon name="Users" size={26} /><span className="text-[10px] font-bold mt-1.5">Öğrenciler</span></button>
                        </div>
                    )}

                    {/* MODALLER (Tasarım Güncellendi) */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-[70]">
                            <div className="glass-modal rounded-[32px] shadow-2xl p-8 w-full max-w-sm border-t-white/50">
                                <h3 className="text-2xl font-black mb-6 flex items-center gap-3 text-gray-800"><div className="p-2 bg-emerald-100/50 rounded-xl text-emerald-600"><Icon name="Settings" size={28} /></div> Yönetici Ayarları</h3>
                                <div className="space-y-6">
                                    <div className="p-6 bg-white/60 rounded-3xl border border-white/50 shadow-sm">
                                        <h4 className="text-lg font-bold text-gray-700 mb-4">Şifre Değiştir</h4>
                                        <p className="text-sm text-gray-500">Şifre değişikliği için Firebase Console > Authentication bölümünü kullanınız.</p>
                                    </div>
                                    <button onClick={() => setIsSettingsOpen(false)} className="w-full bg-gray-100/80 text-gray-700 py-4 rounded-2xl font-bold text-lg hover:bg-gray-200/80 transition-colors">Kapat</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="glass-modal rounded-[32px] shadow-2xl p-8 w-full max-w-md max-h-[90vh] overflow-y-auto border-t-white/50">
                                <h3 className="text-2xl font-black mb-6 text-gray-800 tracking-tight">{editingGroup ? "Grubu Düzenle" : "Yeni Grup Oluşturucu"}</h3>
                                <form onSubmit={handleSaveGroup} className="space-y-5">
                                    <input required placeholder="Grup Adı" value={newGroupName} onChange={e=>setNewGroupName(e.target.value)} className="w-full border-2 border-gray-200/80 p-4 rounded-2xl text-lg outline-none focus:border-emerald-500 bg-white/80 font-bold text-gray-800 transition-all focus:bg-white shadow-sm" />
                                    <div className="relative">
                                        <select required className="w-full border-2 border-gray-200/80 p-4 rounded-2xl outline-none focus:border-emerald-500 bg-white/80 font-bold text-gray-700 text-lg appearance-none shadow-sm" value={newCoachName} onChange={e=>setNewCoachName(e.target.value)}><option value="">Antrenör Seç...</option>{definedCoaches.map(inst => <option key={inst.id} value={inst.name}>{inst.name}</option>)}</select>
                                        <Icon name="ChevronLeft" className="absolute right-4 top-5 rotate-90 text-gray-400 pointer-events-none" />
                                    </div>
                                    <div className="p-5 bg-gray-50/50 rounded-3xl space-y-4 border border-gray-100/50"><div className="text-xs font-bold text-gray-500 uppercase tracking-wider">PROGRAM EKLE</div><div className="flex gap-3"><select value={tempDay} onChange={e=>setTempDay(e.target.value)} className="flex-1 border-2 border-gray-200/80 p-3 rounded-2xl outline-none bg-white/80 text-sm font-medium shadow-sm"><option value="Cumartesi">Cumartesi</option><option value="Pazar">Pazar</option></select><select value={tempTime} onChange={e=>setTempTime(e.target.value)} className="w-28 border-2 border-gray-200/80 p-3 rounded-2xl outline-none bg-white/80 text-sm font-medium shadow-sm">{validHours.map(h => <option key={h} value={h}>{h}</option>)}</select><button type="button" onClick={addScheduleSlot} className="bg-lime-500 text-white px-4 rounded-2xl shadow-md hover:bg-lime-600"><Icon name="Plus" size={24} /></button></div><div className="space-y-2 mt-4">{tempSchedule.map((s, idx) => (<div key={idx} className="flex justify-between items-center bg-white/80 border border-emerald-100/50 p-3 rounded-2xl shadow-sm"><span className="text-sm font-bold text-gray-700 flex items-center gap-2"><Icon name="Calendar" size={14} className="text-emerald-500"/> {s.day} - {s.time}</span><button type="button" onClick={() => removeScheduleSlot(idx)} className="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded-xl"><Icon name="Minus" size={18} /></button></div>))}{tempSchedule.length === 0 && <div className="text-sm text-gray-400 text-center py-4 font-medium italic">Henüz saat eklenmedi.</div>}</div></div>
                                    <div className="flex gap-4 mt-8"><button type="button" onClick={() => { setIsModalOpen(false); setEditingGroup(null); }} className="flex-1 py-4 bg-gray-100/80 rounded-2xl text-gray-600 font-bold text-lg hover:bg-gray-200/80 transition-colors">İptal</button><button type="submit" className="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold text-lg shadow-md hover:bg-emerald-700 transition-colors">{editingGroup ? "Güncelle" : "Oluştur"}</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                    {isCoachModalOpen && (<div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50"><div className="glass-modal rounded-[32px] shadow-2xl p-8 w-full max-w-md border-t-white/50"><h3 className="text-2xl font-black mb-6 text-gray-800 tracking-tight">Yeni Antrenör Ekle</h3><form onSubmit={handleAddCoach} className="space-y-5"><input required placeholder="Ad Soyad" value={newInstName} onChange={e=>setNewInstName(e.target.value)} className="w-full border-2 border-gray-200/80 p-4 rounded-2xl text-lg outline-none focus:border-emerald-500 bg-white/80 font-bold text-gray-800 transition-all focus:bg-white shadow-sm" /><input required type="email" placeholder="E-posta Adresi (Gmail)" value={newInstEmail} onChange={e=>setNewInstEmail(e.target.value)} className="w-full border-2 border-gray-200/80 p-4 rounded-2xl text-lg outline-none focus:border-emerald-500 bg-white/80 font-bold text-gray-700 transition-all focus:bg-white shadow-sm" /><div className="flex gap-4 mt-8"><button type="button" onClick={()=>setIsCoachModalOpen(false)} className="flex-1 py-4 bg-gray-100/80 rounded-2xl text-gray-600 font-bold text-lg hover:bg-gray-200/80 transition-colors">İptal</button><button type="submit" className="flex-1 py-4 bg-orange-500 text-white rounded-2xl font-bold text-lg shadow-md hover:bg-orange-600 transition-colors">Ekle</button></div></form></div></div>)}
                    
                    {isStudentModalOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="glass-modal rounded-[32px] shadow-2xl p-8 w-full max-w-md max-h-[90vh] overflow-y-auto border-t-white/50">
                                <h3 className="text-2xl font-black mb-6 text-gray-800 tracking-tight">{editingStudent ? "Öğrenciyi Düzenle" : "Yeni Öğrenci Ekle"}</h3>
                                <form onSubmit={handleAddStudentGlobal} className="space-y-5">
                                    <div className="flex justify-center mb-6">
                                        <div className="w-28 h-28 rounded-full bg-gray-50/50 border-4 border-dashed border-gray-200/80 flex items-center justify-center relative overflow-hidden group hover:border-emerald-400 transition-colors">
                                            {newStudentPhoto ? <img src={newStudentPhoto} className="w-full h-full object-cover" /> : <div className="text-center"><Icon name="Camera" size={28} className="text-gray-300 mx-auto mb-1 group-hover:text-emerald-400"/><span className="text-xs text-gray-400 font-bold group-hover:text-emerald-500">Fotoğraf<br/>Seç</span></div>}
                                            <input type="file" ref={photoInputRef} onChange={handlePhotoChange} className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" />
                                        </div>
                                    </div>
                                    <div className="space-y-3 p-5 bg-gray-50/50 rounded-3xl border border-gray-100/50"><label className="text-xs font-bold text-gray-500 ml-1 uppercase tracking-wider">ÖĞRENCİ BİLGİSİ</label><input placeholder="Ad Soyad" value={newStudentName} onChange={e=> setNewStudentName(e.target.value)} className="w-full border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/80 font-medium transition-all focus:bg-white shadow-sm" /><div className="grid grid-cols-2 gap-3"><input type="number" placeholder="Yaş" value={newStudentAge} onChange={e=>setNewStudentAge(e.target.value)} className="border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/80 font-medium transition-all focus:bg-white shadow-sm" /><input type="tel" placeholder="Telefon No" value={newStudentPhone} onChange={e=>setNewStudentPhone(e.target.value)} className="border-2 border-gray-200/80 p-3 rounded-2xl text-sm outline-none focus:border-emerald-500 bg-white/80 font-medium transition-all focus:bg-white shadow-sm" /></div></div>
                                    {!editingStudent && (
                                        <div className="pt-2 p-5 bg-gray-50/50 rounded-3xl border border-gray-100/50"><label className="text-xs font-bold text-gray-500 ml-1 uppercase tracking-wider">HEDEF GRUP (İsteğe Bağlı)</label><div className="relative mt-2"><select className="w-full border-2 border-gray-200/80 p-3 rounded-2xl outline-none bg-white/80 text-sm font-medium shadow-sm appearance-none" value={selectedGroupIdForStudent} onChange={(e) => setSelectedGroupIdForStudent(e.target.value)}><option value="">Grup Seçiniz (Opsiyonel)...</option>{groups.map(g => (<option key={g.id} value={g.id}>{g.name} ({g.schedule ? g.schedule.length : 0} ders/hf)</option>))}</select><Icon name="ChevronLeft" className="absolute right-4 top-4 rotate-90 text-gray-400 pointer-events-none" size={16} /></div></div>
                                    )}
                                    <div className="flex gap-4 mt-8"><button type="button" onClick={()=>{setIsStudentModalOpen(false); setEditingStudent(null); setNewStudentName(""); setNewStudentAge(""); setNewStudentPhone(""); setNewStudentPhoto(null);}} className="flex-1 py-4 bg-gray-100/80 rounded-2xl text-gray-600 font-bold text-lg hover:bg-gray-200/80 transition-colors">İptal</button><button type="submit" className="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold text-lg shadow-md hover:bg-emerald-700 transition-colors">{editingStudent ? "Güncelle" : "Kaydet"}</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {isAddExistingStudentModalOpen && targetGroupForAdd && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="glass-modal rounded-[32px] shadow-2xl p-8 w-full max-w-sm max-h-[80vh] flex flex-col border-t-white/50">
                                <h3 className="text-2xl font-black mb-2 tracking-tight text-gray-800">Gruba Öğrenci Ekle</h3>
                                <p className="text-sm text-emerald-600 font-bold mb-6 bg-emerald-50/50 p-2 rounded-xl inline-block border border-emerald-100/50 flex items-center gap-2"><Icon name="Layers" size={16}/> {targetGroupForAdd.name}</p>
                                <div className="flex-1 overflow-y-auto border-2 border-gray-100/50 rounded-3xl p-3 mb-6 bg-white/40 backdrop-blur-sm">
                                    {registeredStudents.filter(s => !targetGroupForAdd.players.some(p => p.id === s.id)).length === 0 ? <p className="text-center text-gray-400 py-8 font-medium italic">Eklenecek öğrenci kalmadı.</p> : 
                                    registeredStudents.filter(s => !targetGroupForAdd.players.some(p => p.id === s.id)).map(s => (
                                        <div key={s.id} onClick={() => handleToggleSelection(s.id)} className={`flex items-center gap-4 p-4 mb-2 rounded-2xl cursor-pointer border-2 transition-all ${selectedMemberIds.includes(s.id) ? 'bg-emerald-100/80 border-emerald-500 shadow-sm' : 'bg-white/70 border-transparent hover:bg-white/90 shadow-sm'}`}>
                                            <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${selectedMemberIds.includes(s.id) ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300 bg-white'}`}>{selectedMemberIds.includes(s.id) && <Icon name="CheckSquare" size={16} />}</div>
                                            {s.photo ? <img src={s.photo} className="student-photo-sm ring-2 ring-white shadow-sm" /> : <div className="student-photo-sm bg-gray-200 flex items-center justify-center text-[10px] text-gray-500 font-bold ring-2 ring-white shadow-sm">?</div>}
                                            <div className="text-sm font-bold text-gray-800">{s.name || "İsimsiz"}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4"><button type="button" onClick={() => {setIsAddExistingStudentModalOpen(false); setSelectedMemberIds([]);}} className="flex-1 py-4 bg-gray-100/80 rounded-2xl text-gray-600 font-bold text-lg hover:bg-gray-200/80 transition-colors">İptal</button><button onClick={handleAddMultipleExistingStudents} className="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold text-lg shadow-md hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled={selectedMemberIds.length === 0}>Seçilenleri Ekle ({selectedMemberIds.length})</button></div>
                            </div>
                        </div>
                    )}

                    {viewingProfileStudent && <StudentProfileModal student={viewingProfileStudent} groups={groups} onClose={() => setViewingProfileStudent(null)} />}
                    <LoginPopup />
                    <ConfirmationDialog isOpen={confirmModal.isOpen} message={confirmModal.message} onConfirm={executeConfirm} onCancel={closeConfirmModal} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
