<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diyarbakır Tenis Kulübü</title>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#065f46">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            // Sadece kritik hataları göster
            if(msg.indexOf("Script error") === -1) {
                console.error("Hata Yakalandı:", msg);
            }
        };
    </script>
</head>
<body class="bg-emerald-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // 1. FIREBASE BAŞLATMA (Hemen çalışsın)
        const firebaseConfig = {
          apiKey: "AIzaSyCsOde5aNv6HnNJMXtPLlGisXF_zXp3E5o",
          authDomain: "diyarbakirtenis-254b1.firebaseapp.com",
          projectId: "diyarbakirtenis-254b1",
          storageBucket: "diyarbakirtenis-254b1.firebasestorage.app",
          messagingSenderId: "664290250808",
          appId: "1:664290250808:web:bd0ff27083ea50f145d6cd",
          measurementId: "G-LL1R6KD89Q"
        };

        try {
            const app = initializeApp(firebaseConfig);
            // Global değişkenlere ata ki React erişebilsin
            window.firebaseAuth = getAuth(app);
            window.firebaseDb = getFirestore(app);
            window.firebaseUtils = { 
                signInWithEmailAndPassword, createUserWithEmailAndPassword, firebaseSignOut, 
                onAuthStateChanged, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where 
            };
            console.log("Firebase Başlatıldı ✅");
        } catch(e) { 
            console.error("Firebase Hatası:", e);
            alert("Bağlantı Hatası: Lütfen sayfayı yenileyin.");
        }

        const { useState, useEffect, useMemo, useRef } = React;

        // --- İKONLAR ---
        const Icon = ({ name, size = 20, className }) => {
            const icons = {
                ChartPie: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z"/>,
                Settings: <circle cx="12" cy="12" r="3"/>,
                Key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778"/>,
                Camera: <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>,
                UserCheck: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>,
                UserX: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>,
                Plus: <path d="M12 5v14M5 12h14"/>,
                Minus: <path d="M5 12h14"/>,
                ChevronLeft: <path d="M15 18l-6-6 6-6"/>,
                ChevronRight: <path d="M9 18l6-6-6-6"/>,
                Trash2: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                Calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>,
                Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>,
                UserSquare: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>,
                Layers: <polygon points="12 2 2 7 12 12 22 7 12 2"/>,
                Users: <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>,
                Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/>,
                Info: <circle cx="12" cy="12" r="10"/>,
                UserPlus: <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>,
                Mail: <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4"/>,
                Edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>,
                AlertCircle: <circle cx="12" cy="12" r="10"/>,
                CheckSquare: <polyline points="9 11 12 14 22 4"/>,
                Square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>,
                Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        const getDayNameFromDate = (dateStr) => {
            const date = new Date(dateStr);
            const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            return days[date.getDay()];
        };

        // --- Header Bileşeni ---
        const Header = ({ title, showBack = false, onBack, userRole, currentCoach, onShowLogin, onLogout, logoUrl, onLogoUpdate, onOpenSettings }) => {
            const fileInputRef = useRef(null);
            const handleLogoClick = () => { if(userRole === 'admin' && fileInputRef.current) fileInputRef.current.click(); };
            const handleFileChange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = () => onLogoUpdate(reader.result); reader.readAsDataURL(file); } };

            return (
                <div className="bg-emerald-900/90 backdrop-blur-md p-4 text-white shadow-lg flex justify-between items-center sticky top-0 z-30 border-b border-white/10">
                    <div className="flex items-center gap-3">
                        {showBack ? ( <button onClick={onBack} className="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-colors"><Icon name="ChevronLeft" size={24} /></button> ) : (
                            <div onClick={handleLogoClick} className="w-10 h-10 rounded-full flex items-center justify-center overflow-hidden border-2 border-lime-400 relative bg-white">
                                <img src={logoUrl || "https://cdn-icons-png.flaticon.com/512/33/33736.png"} alt="Logo" className="w-full h-full object-cover" />
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                            </div>
                        )}
                        <div><h1 className="text-lg font-bold leading-tight font-sport">{title}</h1></div>
                    </div>
                    <div className="flex gap-2">
                        {userRole === 'admin' && ( <button onClick={onOpenSettings} className="p-2 rounded-full bg-emerald-800/50 text-white border border-white/20" title="Ayarlar"><Icon name="Settings" size={20} /></button> )}
                        {userRole === 'guest' ? ( <button onClick={onShowLogin} className="p-2 rounded-full bg-emerald-900 border-emerald-700 text-emerald-400 border-2"><Icon name="Lock" size={20} /></button> ) : ( <button onClick={onLogout} className="p-2 rounded-full bg-red-500/80 text-white border border-red-400"><Icon name="LogOut" size={20} /></button> )}
                    </div>
                </div>
            );
        };

        const HorizontalCalendar = ({ selectedDate, onSelectDate }) => {
            const days = useMemo(() => {
                const result = [];
                const current = new Date(selectedDate);
                for (let i = -14; i <= 14; i++) {
                    const d = new Date(current);
                    d.setDate(current.getDate() + i);
                    if (d.getDay() === 0 || d.getDay() === 6) result.push(d);
                }
                return result.sort((a, b) => a - b);
            }, [selectedDate]);

            return (
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-4 px-4 bg-emerald-900/90 backdrop-blur-md text-white shadow-inner border-b border-white/10">
                    {days.map((date, idx) => {
                        const dateStr = date.toISOString().split('T')[0];
                        const isSelected = dateStr === selectedDate;
                        const d = new Date(dateStr);
                        const dayName = new Intl.DateTimeFormat('tr-TR', { weekday: 'short' }).format(d);
                        const dayNum = d.getDate();
                        return (
                            <button key={idx} onClick={() => onSelectDate(dateStr)} className={`flex flex-col items-center justify-center min-w-[58px] p-2 rounded-2xl border ${isSelected ? 'bg-lime-400 text-emerald-900 font-bold scale-105' : 'hover:bg-white/10 text-emerald-100 border-transparent'}`}>
                                <span className="text-[10px] uppercase opacity-80">{dayName}</span><span className="text-xl font-black">{dayNum}</span>
                            </button>
                        );
                    })}
                </div>
            );
        };

        // --- ANA UYGULAMA (DÜZELTİLDİ) ---
        const App = () => {
            const [isFirebaseReady, setIsFirebaseReady] = useState(false); // YENİ: Firebase hazır mı kontrolü
            const [userRole, setUserRole] = useState(() => { const saved = localStorage.getItem('dtk_session_v1'); return saved ? JSON.parse(saved).role : null; });
            const [currentCoach, setCurrentCoach] = useState(() => { const saved = localStorage.getItem('dtk_session_v1'); return saved ? JSON.parse(saved).name : null; });
            const [appLogo, setAppLogo] = useState("https://cdn-icons-png.flaticon.com/512/33/33736.png");
            const [adminPassword, setAdminPassword] = useState("2121");
            const [selectedDate, setSelectedDate] = useState(() => { const today = new Date(); const offset = today.getTimezoneOffset(); const localDate = new Date(today.getTime() - (offset * 60 * 1000)); return localDate.toISOString().split('T')[0]; });
            const [groups, setGroups] = useState([]);
            const [registeredStudents, setRegisteredStudents] = useState([]);
            const [activeGroup, setActiveGroup] = useState(null);
            
            // 1. ADIM: Firebase'in hazır olmasını bekle
            useEffect(() => {
                const checkFirebase = setInterval(() => {
                    if (window.firebaseUtils && window.firebaseDb) {
                        setIsFirebaseReady(true);
                        clearInterval(checkFirebase);
                    }
                }, 100); // 100ms'de bir kontrol et
                return () => clearInterval(checkFirebase);
            }, []);

            // 2. ADIM: Veri Çekme (Sadece Firebase hazırsa çalışır)
            useEffect(() => {
                if(!isFirebaseReady) return; // HAZIR DEĞİLSE ÇALIŞMA!

                try {
                    const unsub1 = window.firebaseUtils.onSnapshot(window.firebaseUtils.collection(window.firebaseDb, 'groups'), (snap) => {
                        const data = [];
                        snap.forEach(d => {
                            const grp = d.data();
                            data.push({ 
                                ...grp, 
                                id: d.id, 
                                players: grp.players || [], 
                                records: grp.records || {}, 
                                schedule: grp.schedule || [] 
                            });
                        });
                        setGroups(data);
                    });

                    const unsub2 = window.firebaseUtils.onSnapshot(window.firebaseUtils.collection(window.firebaseDb, 'students'), (snap) => {
                        const data = [];
                        snap.forEach(d => data.push({ ...d.data(), id: d.id }));
                        setRegisteredStudents(data);
                    });
                    
                    // Ayarları çek
                    const settingsRef = window.firebaseUtils.doc(window.firebaseDb, 'settings', 'app');
                    const unsub3 = window.firebaseUtils.onSnapshot(settingsRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            if (data.logo) setAppLogo(data.logo);
                        }
                    });

                    return () => { unsub1(); unsub2(); unsub3(); };
                } catch(err) {
                    console.error("Veri çekme hatası:", err);
                }
            }, [isFirebaseReady]); // Bu etki, sadece isFirebaseReady değişince çalışır

            // Yükleniyor Ekranı (Firebase uyanana kadar bunu göster)
            if (!isFirebaseReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-emerald-900 text-white flex-col">
                        <div className="w-12 h-12 border-4 border-lime-400 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <h2 className="text-xl font-bold">Sistem Yükleniyor...</h2>
                        <p className="text-sm opacity-70">Veritabanına bağlanılıyor</p>
                    </div>
                );
            }

            const toggleAttendance = async (playerId, status) => {
                if(!activeGroup) return;
                const recs = activeGroup.records[selectedDate] || {};
                const newStatus = recs[playerId] === status ? null : status;
                const updatedRecords = { ...activeGroup.records, [selectedDate]: { ...recs, [playerId]: newStatus } };
                
                setActiveGroup({ ...activeGroup, records: updatedRecords });
                const groupRef = window.firebaseUtils.doc(window.firebaseDb, 'groups', activeGroup.id.toString());
                await window.firebaseUtils.updateDoc(groupRef, { records: updatedRecords });
            };

            const handleLogout = () => { setUserRole(null); localStorage.removeItem('dtk_session_v1'); };
            const currentDayName = getDayNameFromDate(selectedDate);
            const dailyGroups = groups.filter(g => g.schedule && g.schedule.some(s => s.day === currentDayName));

            // GİRİŞ EKRANI
            if (!userRole) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-emerald-800">
                        <div className="bg-white p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl">
                            <img src={appLogo} className="w-24 h-24 mx-auto rounded-full mb-4 border-4 border-lime-400 object-cover"/>
                            <h1 className="text-2xl font-bold mb-6 text-gray-800">Diyarbakır Tenis</h1>
                            <button onClick={() => { setUserRole('coach'); localStorage.setItem('dtk_session_v1', JSON.stringify({role:'coach', name:'Mert Hoca'})); }} className="w-full bg-lime-500 py-3 rounded-xl font-bold mb-3 hover:bg-lime-400 transition">Antrenör Girişi</button>
                            <button onClick={() => { setUserRole('admin'); localStorage.setItem('dtk_session_v1', JSON.stringify({role:'admin'})); }} className="w-full bg-gray-200 py-3 rounded-xl font-bold hover:bg-gray-300 transition">Yönetici Girişi</button>
                        </div>
                    </div>
                );
            }

            // GRUP DETAY
            if (activeGroup) {
                const recs = (activeGroup.records || {})[selectedDate] || {};
                const players = activeGroup.players || [];
                return (
                    <div className="min-h-screen bg-emerald-50 flex flex-col">
                        <Header title={activeGroup.name} showBack={true} onBack={() => setActiveGroup(null)} userRole={userRole} />
                        <div className="p-4 flex-1 overflow-y-auto pb-20">
                            {players.length === 0 ? <div className="text-center text-gray-500 mt-10">Bu grupta öğrenci yok.</div> : 
                            players.map(p => {
                                const status = recs[p.id];
                                return (
                                    <div key={p.id} className="bg-white p-4 rounded-2xl mb-3 shadow-sm flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">{p.name.charAt(0)}</div>
                                            <span className="font-bold text-gray-800">{p.name}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => toggleAttendance(p.id, 'present')} className={`p-3 rounded-xl border ${status === 'present' ? 'bg-lime-500 text-white' : 'bg-gray-100 text-gray-400'}`}><Icon name="UserCheck"/></button>
                                            <button onClick={() => toggleAttendance(p.id, 'absent')} className={`p-3 rounded-xl border ${status === 'absent' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-400'}`}><Icon name="UserX"/></button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            // ANA EKRAN
            return (
                <div className="min-h-screen bg-emerald-50 flex flex-col">
                    <Header title="Ders Programı" userRole={userRole} onLogout={handleLogout} logoUrl={appLogo} onLogoUpdate={()=>{}} onOpenSettings={()=>{}} />
                    <HorizontalCalendar selectedDate={selectedDate} onSelectDate={setSelectedDate} />
                    <div className="p-4 flex-1 overflow-y-auto pb-20">
                        <h2 className="text-xl font-bold text-emerald-800 mb-4 px-2">{currentDayName} Dersleri</h2>
                        {dailyGroups.length === 0 ? <div className="text-center text-gray-400 mt-10 p-10 border-2 border-dashed rounded-3xl">Bugün ders yok.</div> :
                        dailyGroups.map(g => (
                            <div key={g.id} onClick={() => setActiveGroup(g)} className="bg-white p-6 rounded-3xl shadow-sm mb-4 border border-emerald-100 cursor-pointer hover:shadow-md transition-all relative">
                                <div className="absolute top-0 right-0 bg-emerald-100 text-emerald-800 px-4 py-2 rounded-bl-2xl rounded-tr-3xl font-bold text-sm">
                                    {g.schedule.find(s => s.day === currentDayName)?.time}
                                </div>
                                <h3 className="text-xl font-black text-gray-800 mb-1 mt-2">{g.name}</h3>
                                <p className="text-gray-500 text-sm flex items-center gap-2"><Icon name="UserSquare" size={16}/> {g.instructor}</p>
                                <div className="mt-4 pt-4 border-t border-gray-100 flex justify-between text-sm font-medium text-gray-600">
                                    <span>{(g.players || []).length} Öğrenci</span>
                                    <span className="text-emerald-600 flex items-center gap-1">Yoklama Al <Icon name="ChevronRight" size={16}/></span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
